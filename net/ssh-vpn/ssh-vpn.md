

# 参考

- [SSH_VPN](https://help.ubuntu.com/community/SSH_VPN)



# setup


```bash



docker network prune
docker-compose build
docker-compose up -d --build 
docker-compose down

# sys_tun_open: /dev/tun0 open failed: No such file or directory
# network device support->universal TUN/TAP device driver support,


# client0
docker exec -it my-ssh-vpn-client0 sh
ssh  -NTCf -w 0:0 172.30.20.102

ip addr show tun0           # 没有 ip 地址

ifconfig                    # 没有 tun0
ip link set tun0 up
ip addr add 172.30.40.101/32 peer 172.30.40.102 dev tun0
ifconfig                    # 有 tun0, 有 ip 地址




ip route add 172.30.30.0/24 via 172.30.40.101


# 启动 tun0
#ip link set tun0 up
# 配置 tun0


ssh -NTC -w any:any 172.30.20.102
ssh -v -NTC -w any:any root@localhost


# server0
docker exec -it my-ssh-vpn-server0 sh
ip link set tun0 up
ip addr add 172.30.40.102/32 peer 172.30.40.101 dev tun0
 
arp -sD 172.30.40.101 eth0 pub



```



## nat
|     | client0|server0|server1|
|----|-----|----|----|
| eth0  |172.30.10.101  |172.30.20.102|172.30.30.102 |
| eth1  |172.30.20.101  |172.30.30.101||



server0 默认 的 iptables-save 结果如下 `/etc/iptables/rules-save` :

```bash
/ # iptables-save
# Generated by iptables-save v1.6.1 on Mon Nov 19 16:04:44 2018
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:DOCKER_OUTPUT - [0:0]
:DOCKER_POSTROUTING - [0:0]
-A OUTPUT -d 127.0.0.11/32 -j DOCKER_OUTPUT
-A POSTROUTING -d 127.0.0.11/32 -j DOCKER_POSTROUTING
-A DOCKER_OUTPUT -d 127.0.0.11/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 127.0.0.11:38393
-A DOCKER_OUTPUT -d 127.0.0.11/32 -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.11:50545
-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p tcp -m tcp --sport 38393 -j SNAT --to-source :53
-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p udp -m udp --sport 50545 -j SNAT --to-source :53
COMMIT
# Completed on Mon Nov 19 16:04:44 2018
# Generated by iptables-save v1.6.1 on Mon Nov 19 16:04:44 2018
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
# Completed on Mon Nov 19 16:04:44 2018
```

全部清空

```bash

iptables -F
iptables -X
iptables --flush 
iptables --table nat --flush
iptables --table mangle --flush
iptables --delete-chain
iptables --table nat --delete-chain
iptables --table mangle --flush

iptables -t nat -Z          # 重置计数器
iptables -t nat -L -v -n    # 查看所有规则


```

之后变成如下内容

```bash
# Generated by iptables-save v1.6.1 on Mon Nov 19 16:06:19 2018
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on Mon Nov 19 16:06:19 2018
# Generated by iptables-save v1.6.1 on Mon Nov 19 16:06:19 2018
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on Mon Nov 19 16:06:19 2018
# Generated by iptables-save v1.6.1 on Mon Nov 19 16:06:19 2018
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
# Completed on Mon Nov 19 16:06:19 2018```
```


测试

```txt
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [5:289]
:POSTROUTING ACCEPT [7:430]
:DOCKER_OUTPUT - [0:0]
:DOCKER_POSTROUTING - [0:0]
-A OUTPUT -d 127.0.0.11/32 -j DOCKER_OUTPUT
-A POSTROUTING -d 127.0.0.11/32 -j DOCKER_POSTROUTING
-A DOCKER_OUTPUT -d 127.0.0.11/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 127.0.0.11:42367
-A DOCKER_OUTPUT -d 127.0.0.11/32 -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.11:42331
-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p tcp -m tcp --sport 42367 -j SNAT --to-source :53
-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p udp -m udp --sport 42331 -j SNAT --to-source :53
COMMIT
# Completed on Mon Nov 19 15:51:48 2018
# Generated by iptables-save v1.6.1 on Mon Nov 19 15:51:48 2018
*filter
:INPUT ACCEPT [28:8455]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [27:2204]
COMMIT
# Completed on Mon Nov 19 15:51:48 2018
```


```bash
iptables -A INPUT --match multiport -p tcp --sports 28:8455  -j ACCEPT

-A OUTPUT -d 127.0.0.11/32 -j DOCKER_OUTPUT
-A POSTROUTING -d 127.0.0.11/32 -j DOCKER_POSTROUTING
-A DOCKER_OUTPUT -d 127.0.0.11/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 127.0.0.11:38393
-A DOCKER_OUTPUT -d 127.0.0.11/32 -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.11:50545
-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p tcp -m tcp --sport 38393 -j SNAT --to-source :53
-A DOCKER_POSTROUTING -s 127.0.0.11/32 -p udp -m udp --sport 50545 -j SNAT --to-source :53


#####  DOCKER 配置 DNS
iptables -t nat -N DOCKER_OUTPUT
iptables -t nat -N DOCKER_POSTROUTING
iptables -t nat -A OUTPUT -d 127.0.0.11/32 -j DOCKER_OUTPUT
iptables -t nat -A POSTROUTING -d 127.0.0.11/32 -j DOCKER_POSTROUTING
iptables -t nat -A DOCKER_OUTPUT -d 127.0.0.11/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 127.0.0.11:38393
iptables -t nat -A DOCKER_OUTPUT -d 127.0.0.11/32 -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.11:50545
iptables -t nat -A DOCKER_POSTROUTING -s 127.0.0.11/32 -p tcp -m tcp --sport 38393 -j SNAT --to-source :53
iptables -t nat -A DOCKER_POSTROUTING -s 127.0.0.11/32 -p udp -m udp --sport 50545 -j SNAT --to-source :53



#####  CUSTOM
iptables -t nat -A POSTROUTING -s 192.168.10.101 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.20.101 -o eth0 -j MASQUERADE
iptables -t nat -A DOCKER_POSTROUTING -s 127.0.0.11/32 -p udp -m udp --sport 50545 -j SNAT --to-source :53


```


测试脚本

```bash
# client0 : 配置默认网关为 server0 的IP
docker exec -it my-ssh-vpn-client0 sh
route delete default gw 172.30.10.1 
route add default gw 172.30.20.102
route -n



# server0 : 启用路由转发
## 临时
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
cat /etc/sysctl.conf

# server0 : 启用 SNAT
## Flush all the rules in filter and nat tables
iptables -F
iptables -X
iptables --flush 
iptables --table nat --flush
iptables --table mangle --flush
iptables --delete-chain
iptables --table nat --delete-chain
iptables --table mangle --flush

iptables -t nat -Z          # 重置计数器
iptables -t nat -L -v -n    # 查看所有规则


# Define chain to log and drop incoming packets
iptables -X chain-incoming-log-and-drop
iptables -N chain-incoming-log-and-drop
iptables -A chain-incoming-log-and-drop -j NFLOG --nflog-prefix "[fw-inc-drop]:" --nflog-group 11
iptables -A chain-incoming-log-and-drop -j DROP

# Define chain to log and drop outgoing packets
iptables -X chain-outgoing-log-and-drop
iptables -N chain-outgoing-log-and-drop
iptables -A chain-outgoing-log-and-drop -j NFLOG --nflog-prefix "[fw-out-drop]:" --nflog-group 11
iptables -A chain-outgoing-log-and-drop -j DROP 

# Log not accounted outgoing traffic
iptables -A OUTPUT -j chain-outgoing-log-and-drop


#iptables -t nat -A POSTROUTING -o eth0 -s 172.30.10.0/24 -j SNAT --to 172.30.20.102
iptables -t nat -A POSTROUTING -o eth1 -j SNAT --to 172.30.30.101

#iptables -t nat -A POSTROUTING -o eth1 -s 172.30.20.101 -j SNAT --to 172.30.30.101
#iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
iptables -A FORWARD -i eth1 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT


iptables -t filter -I FORWARD 1 -p icmp -s 172.30.20.101 -j NFLOG
iptables -t filter -I FORWARD 2 -p icmp -d 172.30.20.101 -j NFLOG

iptables -t raw -A PREROUTING   -p icmp --destination 172.30.30.102 -j NFLOG
iptables -t raw -A OUTPUT       -p icmp --destination 172.30.30.102 -j NFLOG





cat /var/log/kern.log | grep 'TRACE:'

# LOG
-j LOG --log-prefix "rule description"


iptables -t nat -A POSTROUTING -s 192.168.10.101 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.20.101 -o eth0 -j MASQUERADE

iptables -t nat -A POSTROUTING -s 192.168.20.101 -o eth1 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.10.101 -o eth1 -j MASQUERADE

iptables -t nat -A POSTROUTING -s 192.168.20.0/24 -o eth1 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o eth1 -j MASQUERADE

iptables -t nat -A POSTROUTING -s 192.168.20.0/24 -o eth1 -j SNAT --to-source 172.30.30.101
iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o eth1 -j SNAT --to-source 172.30.30.101



iptables --table nat --append POSTROUTING  -s 192.168.1.0/24 --out-interface eth1 -j MASQUERADE
iptables --append FORWARD --in-interface eth0 -j ACCEPT


# client0 : 校验
ping  172.30.30.102

```

https://www.tldp.org/HOWTO/html_single/Masquerading-Simple-HOWTO/
https://www.howtoforge.com/nat_iptables


# iptables

```bash
socat -v tcp-l:1234,fork exec:'/bin/cat' &
socat -v tcp-l:1235,fork exec:'/bin/cat' &

# 端口禁用， 1234 不可访问， 1235 可以
iptables -A INPUT -p tcp --dport 1234 -j DROP
# 端口转发(本机, client访问), 1233 -> 1234, 但因为 1234 被禁用，该端口仍然无法提供服务, client 无法访问服务
iptables -t nat -A PREROUTING -p tcp --dport 1233 -j REDIRECT --to-port 1234
# 端口转发(本机, client访问), 1232 -> 1235, 
# OK, client 无法访问服务, 但server 自己无法通过 1232 访问服务
# 因为外部流量 经过  PREROUTING, 本地访问自身的时候则没有
iptables -t nat -A PREROUTING -p tcp --dport 1232 -j REDIRECT --to-port 1235
# 端口转发(本机, server 自身访问), 1232 -> 1235,
iptables -t nat -A OUTPUT -d 127.0.0.1 -p tcp --dport 1232 -j REDIRECT --to-ports 1235        


  
```



https://github.com/wojas/docker-mac-network

https://www.jianshu.com/p/a0933256c829

:experimental:


## 参考

* link:https://cn.dubbo.apache.org/zh-cn/index.html[apache dubbo]
* org.apache.dubbo.config.spring.context.annotation.DubboConfigConfiguration
* org.apache.dubbo.config.spring.ConfigCenterBean


## error
### 字符串substring下标越界

[source,plain]
----
堆栈
"localhost-startStop-1@2386" daemon prio=5 tid=0x1c nid=NA runnable
  java.lang.Thread.State: RUNNABLE
	  at org.apache.dubbo.common.BaseServiceMetadata.interfaceFromServiceKey(BaseServiceMetadata.java:73)
	  at org.apache.dubbo.rpc.model.FrameworkServiceRepository.keyWithoutGroup(FrameworkServiceRepository.java:97)
	  at org.apache.dubbo.rpc.model.FrameworkServiceRepository.registerProvider(FrameworkServiceRepository.java:58)
	  at org.apache.dubbo.rpc.model.ModuleServiceRepository.registerProvider(ModuleServiceRepository.java:110)


参数：
serviceKey = nacos://nacos.default.svc.cluster.local:8848/org.apache.dubbo.metadata.MetadataService:1.0.0
groupIndex=7
versionIndex=5
serviceKey.substring(groupIndex, versionIndex) # 报错 java.lang.StringIndexOutOfBoundsException
原因：误设置： nacos 的地址 =>  org.apache.dubbo.config.ApplicationConfig#setName
----

### 指定provider的 IP 和端口
* link:https://cn.dubbo.apache.org/en/docs/v2.7/user/examples/invoke-with-specified-ip/[Invoke provider with specified IP port]

[source,java]
----
try {
    // create Address instance based on provider's ip port
    Address address = new Address("10.220.47.253", 20880);
    RpcContext.getContext().setObjectAttachment("address", address);
    return testService.sayHello("Tom");
} catch (Throwable ex){
    return ex.getMessage();
}
----


## dubbo-admin

* link:https://hub.docker.com/r/apache/dubbo-admin[docker.io/apache/dubbo-admin:0.5.0]
*《link:https://github.com/apache/dubbo-admin/wiki/Dubbo-Admin%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E[Dubbo Admin配置说明]》

[source,shell]
----

echo '
server.port=38080
#dubbo.protocol.port=30880
#dubbo.application.qos-port=32222

admin.config-center=nacos://nacos:nacos@11.167.75.235:8848?group=DEFAULT_GROUP&namespace=public
admin.registry.address=nacos://nacos:nacos@11.167.75.235:8848?group=dubbo
admin.metadata-report.address=nacos://nacos:nacos@11.167.75.235:8848?group=dubbo
admin.root.user.name=root
admin.root.user.password=root
admin.check.sessionTimeoutMilli=3600000
server.compression.enabled=true
server.compression.mime-types=text/css,text/javascript,application/javascript
server.compression.min-response-size=10240
admin.check.tokenTimeoutMilli=3600000
admin.check.signSecret=86295dd0c4ef69a1036b0b0c15158d77
dubbo.application.name=dubbo-admin
dubbo.registry.address=${admin.registry.address}
spring.datasource.url=jdbc:h2:mem:~/dubbo-admin;MODE=MYSQL;
spring.datasource.username=sa
spring.datasource.password=
mybatis-plus.global-config.db-config.id-type=none
dubbo.application.logger=slf4j
' > /tmp/application.properties

docker run -it --rm \
    -v /tmp/application.properties:/config/application.properties \
    -p 38080:38080 \
    docker.io/apache/dubbo-admin:0.5.0


#浏览器访问： link:http://localhost:38080[http://localhost:38080]

docker run -it --rm --name tmp_dubbo_admin --entrypoint sh docker.io/apache/dubbo-admin:0.5.0

docker run -it --rm  --entrypoint sh docker.io/apache/dubbo-admin:0.5.0

docker cp tmp_dubbo_admin:/app.jar /tmp/app.jar
----


## ???
[source,shell]
----
-Ddubbo.application.check-serializable=false
-Ddubbo.application.serialize-check-status=DISABLE
-Ddubbo.hessian.allowNonSerializable=true
----


## 序列化：Serialization
- org.apache.dubbo.common.serialize.Serialization
- org.apache.dubbo.common.serialize.hessian2.Hessian2Serialization deserialize

watch org.apache.dubbo.common.serialize.hessian2.Hessian2FactoryManager getSerializerFactory '{params[0],returnObj,throwExp}' -x 3


[source,plain]
----
# dubbo 调用后，对返回值的反序列化调用
ts=2023-08-21 09:56:10;thread_name=arthas-command-execute;id=1dd;is_daemon=true;priority=5;TCCL=com.taobao.pandora.boot.loader.ReLaunchURLClassLoader@79079097
    @org.apache.dubbo.common.serialize.hessian2.Hessian2Serialization.deserialize()
        at org.apache.dubbo.common.serialize.DefaultSerializationExceptionWrapper.deserialize(DefaultSerializationExceptionWrapper.java:57)
        at org.apache.dubbo.rpc.protocol.dubbo.DecodeableRpcResult.decode(DecodeableRpcResult.java:94)
        at org.apache.dubbo.rpc.protocol.dubbo.DecodeableRpcResult.decode(DecodeableRpcResult.java:149)
        at org.apache.dubbo.remoting.transport.DecodeHandler.decode(DecodeHandler.java:62)
        at org.apache.dubbo.remoting.transport.DecodeHandler.received(DecodeHandler.java:50)
        at org.apache.dubbo.remoting.transport.dispatcher.ChannelEventRunnable.run(ChannelEventRunnable.java:62)
        at org.apache.dubbo.common.threadpool.ThreadlessExecutor$RunnableWrapper.run(ThreadlessExecutor.java:152)
        at org.apache.dubbo.common.threadpool.ThreadlessExecutor.waitAndDrain(ThreadlessExecutor.java:77)
        at org.apache.dubbo.rpc.AsyncRpcResult.get(AsyncRpcResult.java:205)
        at org.apache.dubbo.rpc.protocol.AbstractInvoker.waitForResultIfSync(AbstractInvoker.java:287)
        at org.apache.dubbo.rpc.protocol.AbstractInvoker.invoke(AbstractInvoker.java:190)
        at org.apache.dubbo.rpc.listener.ListenerInvokerWrapper.invoke(ListenerInvokerWrapper.java:71)
        at org.apache.dubbo.metrics.filter.MetricsFilter.invoke(MetricsFilter.java:63)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CallbackRegistrationInvoker.invoke(FilterChainBuilder.java:196)
        at org.apache.dubbo.rpc.protocol.ReferenceCountInvokerWrapper.invoke(ReferenceCountInvokerWrapper.java:78)
        at org.apache.dubbo.rpc.cluster.support.AbstractClusterInvoker.invokeWithContext(AbstractClusterInvoker.java:383)
        at org.apache.dubbo.rpc.cluster.support.FailoverClusterInvoker.doInvoke(FailoverClusterInvoker.java:80)
        at org.apache.dubbo.rpc.cluster.support.AbstractClusterInvoker.invoke(AbstractClusterInvoker.java:344)
        at org.apache.dubbo.rpc.cluster.router.RouterSnapshotFilter.invoke(RouterSnapshotFilter.java:46)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.java:108)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.rpc.cluster.filter.support.MetricsClusterFilter.invoke(MetricsClusterFilter.java:50)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.rpc.protocol.dubbo.filter.FutureFilter.invoke(FutureFilter.java:52)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.spring.security.filter.ContextHolderParametersSelectedTransferFilter.invoke(ContextHolderParametersSelectedTransferFilter.java:41)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.rpc.cluster.filter.support.ConsumerClassLoaderFilter.invoke(ConsumerClassLoaderFilter.java:40)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.rpc.cluster.filter.support.ConsumerContextFilter.invoke(ConsumerContextFilter.java:118)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:334)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CallbackRegistrationInvoker.invoke(FilterChainBuilder.java:196)
        at org.apache.dubbo.rpc.cluster.support.wrapper.AbstractCluster$ClusterFilterInvoker.invoke(AbstractCluster.java:91)
        at org.apache.dubbo.rpc.cluster.support.wrapper.MockClusterInvoker.invoke(MockClusterInvoker.java:103)
        at org.apache.dubbo.rpc.cluster.support.wrapper.ScopeClusterInvoker.invoke(ScopeClusterInvoker.java:169)
        at org.apache.dubbo.registry.client.migration.MigrationInvoker.invoke(MigrationInvoker.java:284)
        at org.apache.dubbo.rpc.proxy.InvocationUtil.invoke(InvocationUtil.java:57)
        at org.apache.dubbo.rpc.proxy.InvokerInvocationHandler.invoke(InvokerInvocationHandler.java:75)
        at com.alibaba.security.openapi.service.MetaServiceDubboProxy2.getRiskTagList(MetaServiceDubboProxy2.java:-1)
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-2)
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:566)
        at ognl.OgnlRuntime.invokeMethod(OgnlRuntime.java:899)
        at ognl.OgnlRuntime.callAppropriateMethod(OgnlRuntime.java:1544)
        at ognl.ObjectMethodAccessor.callMethod(ObjectMethodAccessor.java:68)
        at ognl.OgnlRuntime.callMethod(OgnlRuntime.java:1620)
        at ognl.ASTMethod.getValueBody(ASTMethod.java:91)
        at ognl.SimpleNode.evaluateGetValueBody(SimpleNode.java:212)
        at ognl.SimpleNode.getValue(SimpleNode.java:258)
        at ognl.ASTChain.getValueBody(ASTChain.java:141)
        at ognl.SimpleNode.evaluateGetValueBody(SimpleNode.java:212)
        at ognl.SimpleNode.getValue(SimpleNode.java:258)
        at ognl.ASTSequence.getValueBody(ASTSequence.java:63)
        at ognl.SimpleNode.evaluateGetValueBody(SimpleNode.java:212)
        at ognl.SimpleNode.getValue(SimpleNode.java:258)
        at ognl.Ognl.getValue(Ognl.java:470)
        at ognl.Ognl.getValue(Ognl.java:572)
        at ognl.Ognl.getValue(Ognl.java:542)
        at com.taobao.arthas.core.command.express.OgnlExpress.get(OgnlExpress.java:40)
        at com.taobao.arthas.core.command.klass100.OgnlCommand.process(OgnlCommand.java:105)
        at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.process(AnnotatedCommandImpl.java:82)
        at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.access$100(AnnotatedCommandImpl.java:18)
        at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:111)
        at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:108)
        at com.taobao.arthas.core.shell.system.impl.ProcessImpl$CommandProcessTask.run(ProcessImpl.java:385)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
        at java.util.concurrent.FutureTask.run(FutureTask.java:264)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at java.lang.Thread.run(Thread.java:829)
----


## org.apache.dubbo.rpc.Invoker

### org.apache.dubbo.rpc.protocol.injvm.InjvmInvoker
## org.apache.dubbo.rpc.cluster.ClusterInvoker


## SPI
FIXME: 如何禁用某个特定的SPI实现？
[source,plain]
----
- org.apache.dubbo.common.extension.ExtensionLoader#strategies
    - org.apache.dubbo.common.extension.DubboInternalLoadingStrategy : "META-INF/dubbo/internal/" , overridden = false
    - org.apache.dubbo.common.extension.DubboLoadingStrategy : "META-INF/dubbo/" , overridden = true
    - org.apache.dubbo.common.extension.ServicesLoadingStrategy : "META-INF/services/"  : 优先级最低， overridden = true

----


SPI列表

PS: 可以在 idea intellij : Edit : Find : Search Structurally... :
基于 'class, interface & enums' ，再增加 '@SPI' 注解，scope="Project and Libraries" 进行搜索即可。

搜素完的结果，可以全部选中，在按 相应的 'Copy | Paste Special : Copy Reference'  快捷键(MacOS上的是 kbd:[Alt+Shift+Cmd+C] ）复制出所有类名。


[source,plain]
----
com.alibaba.dubbo.common.extension.ExtensionFactory
com.alibaba.dubbo.container.page.PageHandler
org.apache.dubbo.auth.spi.AccessKeyStorage
org.apache.dubbo.auth.spi.Authenticator
org.apache.dubbo.cache.CacheFactory
org.apache.dubbo.common.compiler.Compiler
org.apache.dubbo.common.config.configcenter.DynamicConfigurationFactory
org.apache.dubbo.common.config.OrderedPropertiesProvider
org.apache.dubbo.common.context.ApplicationExt
org.apache.dubbo.common.context.ModuleExt
org.apache.dubbo.common.convert.multiple.MultiValueConverter
org.apache.dubbo.common.convert.Converter
org.apache.dubbo.common.deploy.ApplicationDeployListener
org.apache.dubbo.common.deploy.ModuleDeployListener
org.apache.dubbo.common.extension.ExtensionFactory
org.apache.dubbo.common.extension.ExtensionInjector
org.apache.dubbo.common.infra.InfraAdapter
org.apache.dubbo.common.json.JsonUtil
org.apache.dubbo.common.lang.ShutdownHookCallback
org.apache.dubbo.common.logger.LoggerAdapter
org.apache.dubbo.common.serialize.MultipleSerialization
org.apache.dubbo.common.serialize.Serialization
org.apache.dubbo.common.ssl.CertProvider
org.apache.dubbo.common.status.reporter.FrameworkStatusReporter
org.apache.dubbo.common.status.StatusChecker
org.apache.dubbo.common.store.DataStore
org.apache.dubbo.common.threadpool.event.ThreadPoolExhaustedListener
org.apache.dubbo.common.threadpool.manager.ExecutorRepository
org.apache.dubbo.common.threadpool.ThreadPool
org.apache.dubbo.common.url.component.param.DynamicParamSource
org.apache.dubbo.common.utils.ParameterNameReader
org.apache.dubbo.config.bootstrap.DubboBootstrapStartStopListener
org.apache.dubbo.config.spring.context.DubboSpringInitCustomizer
org.apache.dubbo.config.ConfigInitializer
org.apache.dubbo.config.ConfigPostProcessor  # ⭕️
org.apache.dubbo.config.ServiceListener
org.apache.dubbo.metadata.definition.builder.TypeBuilder
org.apache.dubbo.metadata.report.MetadataReportFactory
org.apache.dubbo.metadata.MetadataParamsFilter
org.apache.dubbo.metadata.ServiceNameMapping
org.apache.dubbo.metrics.collector.MetricsCollector
org.apache.dubbo.metrics.report.MetricsReporterFactory
org.apache.dubbo.metrics.service.MetricsService
org.apache.dubbo.metrics.service.MetricsServiceExporter
org.apache.dubbo.monitor.MonitorFactory
org.apache.dubbo.qos.api.BaseCommand
org.apache.dubbo.qos.permission.PermissionChecker
org.apache.dubbo.qos.probe.LivenessProbe
org.apache.dubbo.qos.probe.ReadinessProbe
org.apache.dubbo.qos.probe.StartupProbe
org.apache.dubbo.registry.client.metadata.MetadataServiceURLBuilder
org.apache.dubbo.registry.client.metadata.ServiceInstanceNotificationCustomizer
org.apache.dubbo.registry.client.migration.MigrationAddressComparator
org.apache.dubbo.registry.client.migration.PreMigratingConditionChecker
org.apache.dubbo.registry.client.RegistryClusterIdentifier
org.apache.dubbo.registry.client.ServiceDiscoveryFactory
org.apache.dubbo.registry.client.ServiceInstanceCustomizer
org.apache.dubbo.registry.integration.RegistryProtocolListener
org.apache.dubbo.registry.integration.ServiceURLCustomizer
org.apache.dubbo.registry.AddressListener
org.apache.dubbo.registry.ProviderFirstParams
org.apache.dubbo.registry.RegistryFactory
org.apache.dubbo.registry.RegistryServiceListener
org.apache.dubbo.remoting.api.connection.ConnectionManager
org.apache.dubbo.remoting.api.pu.PortUnificationTransporter
org.apache.dubbo.remoting.api.WireProtocol
org.apache.dubbo.remoting.exchange.Exchanger
org.apache.dubbo.remoting.http12.h1.Http1ServerTransportListenerFactory
org.apache.dubbo.remoting.http12.h2.Http2ServerTransportListenerFactory
org.apache.dubbo.remoting.http12.message.HttpMessageAdapterFactory
org.apache.dubbo.remoting.http12.message.HttpMessageDecoderFactory
org.apache.dubbo.remoting.http12.message.HttpMessageEncoderFactory
org.apache.dubbo.remoting.http12.ExceptionHandler
org.apache.dubbo.remoting.http3.Http3ServerTransportListenerFactory
org.apache.dubbo.remoting.telnet.TelnetHandler
org.apache.dubbo.remoting.transport.netty4.ChannelAddressAccessor
org.apache.dubbo.remoting.websocket.WebSocketServerTransportListenerFactory
org.apache.dubbo.remoting.ChannelHandler
org.apache.dubbo.remoting.Codec
org.apache.dubbo.remoting.Codec2
org.apache.dubbo.remoting.Dispatcher
org.apache.dubbo.remoting.Transporter
org.apache.dubbo.rpc.cluster.filter.ClusterFilter
org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder
org.apache.dubbo.rpc.cluster.filter.InvocationInterceptorBuilder
org.apache.dubbo.rpc.cluster.governance.GovernanceRuleRepository
org.apache.dubbo.rpc.cluster.interceptor.ClusterInterceptor
org.apache.dubbo.rpc.cluster.router.condition.matcher.pattern.ValuePattern
org.apache.dubbo.rpc.cluster.router.condition.matcher.ConditionMatcherFactory
org.apache.dubbo.rpc.cluster.router.mesh.route.MeshEnvListenerFactory
org.apache.dubbo.rpc.cluster.router.mesh.util.TracingContextProvider
org.apache.dubbo.rpc.cluster.router.state.StateRouterFactory
org.apache.dubbo.rpc.cluster.Cluster
org.apache.dubbo.rpc.cluster.ConfiguratorFactory
org.apache.dubbo.rpc.cluster.LoadBalance
org.apache.dubbo.rpc.cluster.Merger
org.apache.dubbo.rpc.cluster.ProviderURLMergeProcessor
org.apache.dubbo.rpc.cluster.RouterFactory
org.apache.dubbo.rpc.cluster.RuleConverter
org.apache.dubbo.rpc.executor.IsolationExecutorSupportFactory
org.apache.dubbo.rpc.model.ApplicationInitListener
org.apache.dubbo.rpc.model.BuiltinServiceDetector
org.apache.dubbo.rpc.model.PackableMethodFactory
org.apache.dubbo.rpc.model.ScopeModelInitializer
org.apache.dubbo.rpc.protocol.dubbo.ByteAccessor
org.apache.dubbo.rpc.protocol.injvm.ParamDeepCopyUtil
org.apache.dubbo.rpc.protocol.tri.compressor.Compressor
org.apache.dubbo.rpc.protocol.tri.compressor.DeCompressor
org.apache.dubbo.rpc.protocol.tri.rest.argument.ArgumentConverter
org.apache.dubbo.rpc.protocol.tri.rest.argument.ArgumentResolver
org.apache.dubbo.rpc.protocol.tri.rest.filter.RestExtension
org.apache.dubbo.rpc.protocol.tri.rest.filter.RestExtensionAdapter
org.apache.dubbo.rpc.protocol.tri.rest.mapping.RequestMappingResolver
org.apache.dubbo.rpc.protocol.tri.rest.openapi.OpenAPIExtension
org.apache.dubbo.rpc.protocol.tri.route.RequestHandlerMapping
org.apache.dubbo.rpc.protocol.tri.stream.ClientStreamFactory
org.apache.dubbo.rpc.ExporterListener
org.apache.dubbo.rpc.Filter
org.apache.dubbo.rpc.HeaderFilter
org.apache.dubbo.rpc.InvokerListener
org.apache.dubbo.rpc.PathResolver
org.apache.dubbo.rpc.PenetrateAttachmentSelector
org.apache.dubbo.rpc.Protocol
org.apache.dubbo.rpc.ProxyFactory
org.apache.dubbo.rpc.ZoneDetector
org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer
org.apache.dubbo.validation.Validation
----


### org.apache.dubbo.rpc.cluster.filter.ClusterFilter



----
hsf://30.196.226.97/com.alibaba.dangqian.HiService?REGISTRY_CLUSTER=GLOBAL&application=unknow_project_name&background=false&check=false&dubbo=2.0.2&dubbo.metadata.storage-type=remote&group=HSF&include_filter=-cluster-filter&include_router=-cluster-router&init=true&interface=com.alibaba.dangqian.HiService&interfaces=com.alibaba.dangqian.HiService,com.taobao.hsf.remoting.service.GenericService,com.taobao.hsf.remoting.service.EchoService,org.apache.dubbo.rpc.service.GenericService,com.alibaba.dubbo.rpc.service.GenericService&loadbalance=hsfrandom&logger=dubbo-to-hsf&mapping-type=metadata&maxWaitAddressTime=3000&metadata-type=remote&methods=sayHello,sayHi&mg=unknown&migration.delay=10&migration.force=false&migration.step=FORCE_INTERFACE&migration.threshold=0.0&pid=5411&protocol=hsf&proxy=jdk&reference.filter=-genericimpl,-cluster-filter&register-mode=interface&register.ip=30.196.226.97&registry-cluster-type=msha&release=&retries=0&revision=1.0.2-SNAPSHOT&router=-app,-condition,-standard-mesh-rule,-service,-tag,-cluster-router&scope=remote&side=consumer&sticky=false&timeout=300000&timestamp=1705542554802&url-merge-processor=hsf&ut=CENTER&version=1.0.0
----



[source,plain]
----
org.apache.dubbo.common.URL
  org.apache.dubbo.common.url.component.ServiceConfigURL
  org.apache.dubbo.common.url.component.ServiceAddressURL
    org.apache.dubbo.common.url.component.DubboServiceAddressURL
  org.apache.dubbo.registry.client.InstanceAddressURL
  org.apache.dubbo.registry.client.OverrideInstanceAddressURL


# ServiceConfigURL
hsf-registry-protocol://127.0.0.1:3181/org.apache.dubbo.registry.RegistryService?application=unknow_project_name&dubbo=2.0.2&dubbo.metadata.storage-type=remote&logger=dubbo-to-hsf&mapping-type=metadata&metadata-type=remote&pid=30983&preferred=true&register-mode=interface&registry=cs&registry-cluster-type=msha&registry-protocol-type=hsf-registry-protocol&timestamp=1705650182730
----

## log
https://cn.dubbo.apache.org/en/docs3-v2/java-sdk/advanced-features-and-usage/others/logger-management/

[source,shell]
----
telnet 127.0.0.1 22222
help
ls
loggerInfo
----


# ExtensionLoader
org.apache.dubbo.common.extension.ExtensionLoader

[source,shell]
----
sc -d org.apache.dubbo.rpc.model.FrameworkModel

ognl -c 4470fbd6 '
#extensionClazz=@org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer@class,
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#extensionLoader=#frameworkModel.extensionDirector.extensionLoadersMap[#extensionClazz],
#extensionLoader.cachedInstances
' -x 3

# 获取 jackson ObjectMapper
ognl -c 4470fbd6 '
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#appModel=#frameworkModel.defaultAppModel,
#objectMapperCodec=#appModel.getBeanFactory().getBean(@org.apache.dubbo.spring.security.jackson.ObjectMapperCodec@class),
#objectMapper=#objectMapperCodec.mapper
#objectMapper
' -x 3

#  获取 jackson ObjectMapper 注册的 mixin
ognl -c 4470fbd6 '
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#appModel=#frameworkModel.defaultAppModel,
#objectMapperCodec=#appModel.getBeanFactory().getBean(@org.apache.dubbo.spring.security.jackson.ObjectMapperCodec@class),
#objectMapperCodec._mixIns._localMixIns
' -x 3




# 检查有多少个 FrameworkModel 实例
ognl -c 4470fbd6 '@org.apache.dubbo.rpc.model.FrameworkModel@allInstances'
# 检查有多少个 ApplicationModel 实例
ognl -c 4470fbd6 '@org.apache.dubbo.rpc.model.FrameworkModel@allInstances.{  applicationModels}'




ognl -c 4470fbd6 '
#extensionClazz=@org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer@class,
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#extensionLoader=#frameworkModel.extensionDirector.extensionLoadersMap[#extensionClazz],
#extensionLoader.scopeModel
' -x 3

ognl -c 4470fbd6 '
@org.apache.dubbo.common.extension.ExtensionLoader@strategies
' -x 3

ognl -c 4470fbd6 '
#fileName="META-INF/dubbo/org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer",
#classLoader=@com.alibaba.security.gong9.mw.pandora.hsf.impl.dubbo.jackson.G9ObjectMapperCodecCustomer@class.getClassLoader(),
#classLoadersToLoad={#classLoader},
#map=@org.apache.dubbo.common.utils.ClassLoaderResourceLoader@loadResources(#fileName,#classLoadersToLoad),
#extensionClazz=@org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer@class,
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#extensionLoader=#frameworkModel.extensionDirector.extensionLoadersMap[#extensionClazz],
#extensionClasses=#{},
#loadingStrategy=@org.apache.dubbo.common.extension.ExtensionLoader@strategies[1],
#extensionLoader.loadFromClass(
  #extensionClasses,
  #loadingStrategy.overridden(),
  #map.values().toArray()[0],
  #classLoader,
  #loadingStrategy.includedPackages(),
  #loadingStrategy.excludedPackages(),
  #loadingStrategy.onlyExtensionClassLoaderPackages()
),
#extensionClasses
' -x 3

# 读取给定的文件的内容
ognl -c 4470fbd6 '
#fileName="META-INF/dubbo/org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer",
#classLoader=@com.alibaba.security.gong9.mw.pandora.hsf.impl.dubbo.jackson.G9ObjectMapperCodecCustomer@class.getClassLoader(),
#classLoadersToLoad={#classLoader},
#map=@org.apache.dubbo.common.utils.ClassLoaderResourceLoader@loadResources(#fileName,#classLoadersToLoad),
#extensionClazz=@org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer@class,
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#extensionLoader=#frameworkModel.extensionDirector.extensionLoadersMap[#extensionClazz],
#extensionClasses=#{},
#loadingStrategy=@org.apache.dubbo.common.extension.ExtensionLoader@strategies[1],
#extensionLoader.getResourceContent(#map.values().toArray()[0].toArray()[0])
' -x 3

# 读取给定的文件的内容
ognl -c 4470fbd6 '
#fileName="META-INF/dubbo/org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer",
#classLoader=@com.alibaba.security.gong9.mw.pandora.hsf.impl.dubbo.jackson.G9ObjectMapperCodecCustomer@class.getClassLoader(),
#classLoadersToLoad={#classLoader},
#map=@org.apache.dubbo.common.utils.ClassLoaderResourceLoader@loadResources(#fileName,#classLoadersToLoad),
#extensionClazz=@org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer@class,
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#extensionLoader=#frameworkModel.extensionDirector.extensionLoadersMap[#extensionClazz],
#extensionClasses=#{},
#loadingStrategy=@org.apache.dubbo.common.extension.ExtensionLoader@strategies[1],
#url=#map.values().toArray()[0].toArray()[0],
#extensionLoader.loadClass(#classLoader,#extensionClasses,#url),
#extensionClasses
' -x 3


ognl -c 4470fbd6 '
#className="com.alibaba.security.gong9.mw.pandora.hsf.impl.dubbo.jackson.G9ObjectMapperCodecCustomer",
#classLoader=@org.apache.dubbo.config.bootstrap.DubboBootstrap@class.getClassLoader(),
@java.lang.Class@forName(#className, true, #classLoader)
'

ognl -c 4470fbd6 '
#extensionClazz=@org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer@class,
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#extensionLoader=#frameworkModel.extensionDirector.extensionLoadersMap[#extensionClazz],
#extensionLoader.exceptions
' -x 3


FIXME: 为何 #extensionLoader.loadClassIfActive(#classLoader,#class) 有 两个参数，既 传递 classLoader, 又传递 class ?

ognl -c 4470fbd6 '
#clazz=@org.apache.dubbo.spring.security.model.SecurityScopeModelInitializer@class,
#classLoader=@org.apache.dubbo.config.bootstrap.DubboBootstrap@class.getClassLoader(),
#extensionClazz=@org.apache.dubbo.spring.security.jackson.ObjectMapperCodecCustomer@class,
#frameworkModel=@org.apache.dubbo.rpc.model.FrameworkModel@defaultInstance,
#extensionLoader=#frameworkModel.extensionDirector.extensionLoadersMap[#extensionClazz],
#extensionLoader.loadClassIfActive(#classLoader,#clazz)
' -x 3


# true - pandora 插件的classloader的parent==null，但仍然能找到对应的类
ognl -c 4470fbd6 '
#className="org.springframework.security.core.context.SecurityContextHolder",
#classLoader=@org.apache.dubbo.config.bootstrap.DubboBootstrap@class.getClassLoader(),
@org.apache.dubbo.common.utils.ClassUtils@isPresent(#className, #classLoader)
' -x 3

ognl -c 4470fbd6 '
#pandoraPluginClassLoader=@org.apache.dubbo.config.bootstrap.DubboBootstrap@class.getClassLoader(),
#pandoraFramworkClassLoader=#pandoraPluginClassLoader.pandoraClassLoader
' -x 3


----

## @org.apache.dubbo.common.extension.Activate

[source,java]
----
package org.apache.dubbo.spring.security.model;
import org.apache.dubbo.common.extension.Activate;
import org.apache.dubbo.rpc.model.ScopeModelInitializer;
@Activate(onClass = {SECURITY_CONTEXT_HOLDER_CLASS_NAME, CORE_JACKSON_2_MODULE_CLASS_NAME, OBJECT_MAPPER_CLASS_NAME})
public class SecurityScopeModelInitializer implements ScopeModelInitializer {

    //...
}
----


## 基于权重值的比例流量转发

* link:https://cn.dubbo.apache.org/zh-cn/overview/mannual/java-sdk/tasks/traffic-management/weight/[基于权重值的比例流量转发]
* link:https://cn.dubbo.apache.org/zh-cn/overview/what/core-features/traffic/configuration-rule/[动态配置规则]
* org.apache.dubbo.config.AbstractServiceConfig#weight

[source,yaml]
----
configVersion: v3.0
scope: service
key: org.apache.dubbo.samples.OrderService
configs:
  - side: provider
    match:
      param:
        - key: orderVersion
          value:
            exact: v2
    parameters:
      weight: 25
----


## triple 协议

- link:https://cn.dubbo.apache.org/zh-cn/overview/mannual/java-sdk/tasks/protocols/rest/[发布 REST 风格的服务]
- org.apache.dubbo.rpc.protocol.tri.TriplePathResolver
- org.apache.dubbo.rpc.protocol.tri.TripleProtocol#link:https://github.com/apache/dubbo/blob/3.3/dubbo-rpc/dubbo-rpc-triple/src/main/java/org/apache/dubbo/rpc/protocol/tri/TripleProtocol.java#L98[getDefaultPort]

[source,shell]
----
cat > /tmp/data.json <<EOF
[
  "taobao_k8s_daily_test01",
  {
    "userId": "black01"
  }
]
EOF

cat > /tmp/data.json <<EOF
[
  "qooland_public_templete",
  {
    "content": "black01"
  }
]
EOF

curl -XPOST "http://localhost:50051/com.alibaba.security.tenant.common.service.RequestService/request" \
   -H "Content-Type: application/json" \
   -d @/tmp/data.json

curl  --header "Content-Type: application/json" \
--data '["qooland_public_templete",{ "content": "あんまり覚えてないもん(៸៸<1cd0>>𖥦<៸៸<1cd0> )੭ﾞ  "}]'    \
 http://121.199.172.170/com.alibaba.security.tenant.common.service.RequestService/request  \
 -H "Authorization: Bearer eyJraWQiOiJiNDYxMzJiOS0xYzQwLTQ2YTMtODEwMC0xMWMwMWU0MWQyY2MiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJ1cm46ZXhhbXBsZTphdWRpZW5jZSIsInVpZCI6IjEyMzQ1Njc4OTAifQ.U52Cg2paCOcNJU4W4PMYFesJfDd5JAA8tKi7NliQbUyvC0gxdMuYd6WrGJpVlZ7a0zLrMbVf__I7KTE8zu-B-doOKhWujSu9rh1G_R2fkc29wO8M1em2jyVTvibK4Tj8ln1xIo_Fp-IYC5ySCRCOFAjv6B3ObJ0h8iiJ2ftjViOyOs7DntMZ6W8oqlrvhp7McBkiFDkznu9IIjW55bPO72TFuLYU10WxLy2AicJE1l0HFnj7qM7VcF7IBTvxLaBy2lr4MfqdrZAiVbqhV0cd4vnWoJw7Bat2fArq_ZHrm21RrXwgafRdJqqE052YD0Wz-2xzfuMSZTBa7VPaDUJ57g"

curl  \
    --header "Content-Type: application/json" \
    --data '{"content": "black01"}'    \
    'http://121.199.172.170/requestService/invoke?eventCode=qooland_public_templete'  \
    -H "Authorization: Bearer eyJraWQiOiJiNDYxMzJiOS0xYzQwLTQ2YTMtODEwMC0xMWMwMWU0MWQyY2MiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJ1cm46ZXhhbXBsZTphdWRpZW5jZSIsInVpZCI6IjEyMzQ1Njc4OTAifQ.U52Cg2paCOcNJU4W4PMYFesJfDd5JAA8tKi7NliQbUyvC0gxdMuYd6WrGJpVlZ7a0zLrMbVf__I7KTE8zu-B-doOKhWujSu9rh1G_R2fkc29wO8M1em2jyVTvibK4Tj8ln1xIo_Fp-IYC5ySCRCOFAjv6B3ObJ0h8iiJ2ftjViOyOs7DntMZ6W8oqlrvhp7McBkiFDkznu9IIjW55bPO72TFuLYU10WxLy2AicJE1l0HFnj7qM7VcF7IBTvxLaBy2lr4MfqdrZAiVbqhV0cd4vnWoJw7Bat2fArq_ZHrm21RrXwgafRdJqqE052YD0Wz-2xzfuMSZTBa7VPaDUJ57g"


----

相关类:

- org.apache.dubbo.rpc.protocol.tri.rest.mapping.Registration#mapping
- org.apache.dubbo.rpc.protocol.tri.rest.mapping.RequestMapping#consumesCondition
- org.apache.dubbo.rpc.protocol.tri.rest.mapping.condition.ConsumesCondition#match
- org.apache.dubbo.rpc.protocol.tri.rest.mapping.condition.ServiceGroupVersionCondition

[source,bash]
----
# 检查注册的路径
vmtool -x 3 --action getInstances --className org.apache.dubbo.rpc.protocol.tri.rest.mapping.DefaultRequestMappingRegistry  \
--express 'instances[0].tree.directPathMap.keySet().{ #this.toString() }'

vmtool -x 3 -c 78a7fc27 --action getInstances --className org.apache.dubbo.rpc.protocol.tri.rest.mapping.DefaultRequestMappingRegistry  --express '
#path="/com.alibaba.security.tenant.common.service.RequestService/request",
#keyString=new org.apache.dubbo.rpc.protocol.tri.rest.util.KeyString(#path),
instances[0].tree.directPathMap.get(#keyString)[0].value.mapping.customCondition
'

# dubbo.rpc.tri.resolve-fallback-to-default=false
ognl -c 78a7fc27 '@org.apache.dubbo.rpc.protocol.tri.TripleProtocol@RESOLVE_FALLBACK_TO_DEFAULT'
ognl -c 78a7fc27 '@org.apache.dubbo.rpc.protocol.tri.TripleProtocol@class.getField("RESOLVE_FALLBACK_TO_DEFAULT").setBoolean(null,false)'

#

ognl -c 78a7fc27 '
#appModel=@org.apache.dubbo.rpc.model.ApplicationModel@defaultModel(),
#conf=@org.apache.dubbo.common.config.ConfigurationUtils@getEnvConfiguration(#appModel),
#conf.getClass().getName()
'
----


[source,plain]
----
ts=2025-04-11 17:01:01.925;thread_name=DubboServerHandler-169.254.245.134:50051-thread-51;id=13763;is_daemon=true;priority=5;TCCL=com.alibaba.security.mtee.bundle.framework.core.loader.JiugongBundleClassLoader@33e3d49d;trace_id=a9fef58617443620618986475dd92f;rpc_id=9
    @com.taobao.mbus.biz.message.impl.RequestServiceImpl.request()
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-2)
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:566)
        at com.taobao.mbus.biz.message.impl.hsf.HsfMessageSourceListener.invoke(HsfMessageSourceListener.java:78)
        at com.sun.proxy.$Proxy159.request(null:-1)
        at com.alibaba.security.tenant.common.service.RequestServiceDubboWrap3.invokeMethod(RequestServiceDubboWrap3.java:-1)
        at org.apache.dubbo.rpc.proxy.javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:89)
        at org.apache.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.java:100)
        at org.apache.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke(DelegateProviderMetaDataInvoker.java:55)
        at org.apache.dubbo.rpc.protocol.InvokerWrapper.invoke(InvokerWrapper.java:56)
        at org.apache.dubbo.rpc.filter.ClassLoaderCallbackFilter.invoke(ClassLoaderCallbackFilter.java:38)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.protocol.tri.rest.filter.RestExtensionExecutionFilter.lambda$invoke$0(RestExtensionExecutionFilter.java:79)
        at org.apache.dubbo.rpc.protocol.tri.rest.filter.DefaultFilterChain.doFilter(DefaultFilterChain.java:62)
        at org.apache.dubbo.rpc.protocol.tri.rest.filter.RestFilter.doFilter(RestFilter.java:28)
        at org.apache.dubbo.rpc.protocol.tri.rest.filter.DefaultFilterChain.doFilter(DefaultFilterChain.java:58)
        at org.apache.dubbo.rpc.protocol.tri.rest.filter.DefaultFilterChain.execute(DefaultFilterChain.java:51)
        at org.apache.dubbo.rpc.protocol.tri.rest.filter.RestExtensionExecutionFilter.invoke(RestExtensionExecutionFilter.java:82)
        at org.apache.dubbo.rpc.protocol.tri.rest.filter.RestFilterAdapter.invoke(RestFilterAdapter.java:36)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.protocol.tri.h12.HttpContextCallbackFilter.invoke(HttpContextCallbackFilter.java:37)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.protocol.dubbo.filter.TraceFilter.invoke(TraceFilter.java:80)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.TimeoutFilter.invoke(TimeoutFilter.java:45)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.java:109)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.ExceptionFilter.invoke(ExceptionFilter.java:55)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.AccessLogFilter.invoke(AccessLogFilter.java:120)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.GenericFilter.invoke(GenericFilter.java:222)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.protocol.tri.h12.HttpContextFilter.invoke(HttpContextFilter.java:50)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.ClassLoaderFilter.invoke(ClassLoaderFilter.java:54)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.EchoFilter.invoke(EchoFilter.java:41)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.metrics.filter.MetricsFilter.invoke(MetricsFilter.java:86)
        at org.apache.dubbo.metrics.filter.MetricsProviderFilter.invoke(MetricsProviderFilter.java:37)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.ProfilerServerFilter.invoke(ProfilerServerFilter.java:66)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.filter.ContextFilter.invoke(ContextFilter.java:191)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:349)
        at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CallbackRegistrationInvoker.invoke(FilterChainBuilder.java:197)
        at org.apache.dubbo.rpc.protocol.tri.h12.AbstractServerCallListener.invoke(AbstractServerCallListener.java:76)
        at org.apache.dubbo.rpc.protocol.tri.h12.UnaryServerCallListener.onComplete(UnaryServerCallListener.java:50)
        at org.apache.dubbo.rpc.protocol.tri.h12.http1.DefaultHttp11ServerTransportListener$AutoCompleteUnaryServerCallListener.onMessage(DefaultHttp11ServerTransportListener.java:120)
        at org.apache.dubbo.remoting.http12.message.DefaultListeningDecoder.decode(DefaultListeningDecoder.java:42)
        at org.apache.dubbo.rpc.protocol.tri.h12.DefaultHttpMessageListener.onMessage(DefaultHttpMessageListener.java:39)
        at org.apache.dubbo.rpc.protocol.tri.h12.AbstractServerTransportListener.doOnData(AbstractServerTransportListener.java:183)
        at org.apache.dubbo.rpc.protocol.tri.h12.AbstractServerTransportListener.lambda$onData$1(AbstractServerTransportListener.java:168)
        at org.apache.dubbo.common.threadpool.serial.SerializingExecutor.run(SerializingExecutor.java:105)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at org.apache.dubbo.common.threadlocal.InternalRunnable.run(InternalRunnable.java:39)
        at java.lang.Thread.run(Thread.java:991)
----


## 异步调用

- com.alibaba.dubbo.rpc.support.RpcUtils#isAsync


stack org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol refer



== dubbo-metrics
- org.apache.dubbo.metrics.service.MetricsService
- org.apache.dubbo.metrics.filter.MetricsFilter
- org.apache.dubbo.metrics.event.MetricsEvent
- org.apache.dubbo.metrics.event.MetricsEventMulticaster#addListener

- link:https://cn.dubbo.apache.org/en/overview/mannual/java-sdk/reference-manual/merics/meter/[metrics]


== thread-pool
org.apache.dubbo.common.threadpool.ThreadPool

link:https://cn.dubbo.apache.org/zh-cn/overview/mannual/java-sdk/tasks/framework/threading-model/[消费端线程模型，提供者端线程模型]


## 配置

[source,xml]
----
-Ddubbo.protocol.threads=500
<!-- 能进700，并发500 ??? -->
<dubbo:protocol name="dubbo" port="20880"
                threads="500"
                queues="200"
                accepts="700"/>
----

link:https://cn.dubbo.apache.org/zh-cn/overview/mannual/java-sdk/reference-manual/config/properties/[配置项参考手册]

- org.apache.dubbo.common.constants.CommonConstants#THREADS_KEY
- org.apache.dubbo.common.constants.CommonConstants#DEFAULT_THREADS

- org.apache.dubbo.common.config.Configuration
- org.apache.dubbo.common.config.SystemConfiguration
- org.apache.dubbo.config.ProtocolConfig
- com.alibaba.dubbo.config.ProviderConfig # 获取 ProtocolConfig
- org.apache.dubbo.rpc.protocol.tri.websocket.TripleEndpoint#onOpen
- org.apache.dubbo.config.nested.TripleConfig
- org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository#updateThreadpool
- org.apache.dubbo.remoting.Dispatcher
-- org.apache.dubbo.remoting.transport.dispatcher.all.AllDispatcher
-- org.apache.dubbo.remoting.transport.dispatcher.direct.DirectDispatcher
-- org.apache.dubbo.remoting.transport.dispatcher.execution.ExecutionDispatcher
-- org.apache.dubbo.remoting.transport.dispatcher.message.MessageOnlyDispatcher
-- org.apache.dubbo.remoting.transport.dispatcher.connection.ConnectionOrderedDispatcher
- org.apache.dubbo.remoting.transport.dispatcher.WrappedChannelHandler#getSharedExecutorService()
- org.apache.dubbo.common.threadpool.manager.ExecutorRepository
- org.apache.dubbo.common.threadpool.manager.IsolationExecutorRepository

- org.apache.dubbo.common.threadpool.ThreadPool # SPI
- org.apache.dubbo.common.threadpool.support.fixed.FixedThreadPool # 默认实现
- org.apache.dubbo.common.threadpool.support.cached.CachedThreadPool
- org.apache.dubbo.common.threadpool.support.eager.EagerThreadPool
- org.apache.dubbo.common.threadpool.support.limited.LimitedThreadPool

-Ddubble.protocol.threads=400

[source,yaml]
----
dubbo:
  protocol:          # org.apache.dubbo.config.ProtocolConfig
    name: dubbo
    port: -1
    dispatcher: all     # 服务端的线程模型
                        # "all" （默认）, "direct", "execution", "message", "connection"
    threadpool: fixed   # 线程池类型
                        # "fixed"   : 固定大小的线程池类型，默认
                        # "cached"  : 缓存线程池，根据需要创建新线程。
                        # "limited" : 有限线程池，线程数有限，任务队列无限。
                        # "eager"   : 优先创建新线程的线程池。
    threads: 200        # 线程池大小
    corethreads: 100    #
    iothreads: 8        # IO线程数
    queues: 500         # 任务队列长度
    alive:100           # 毫秒, => ThreadPoolExecutor#keepAliveTime (这里是纳秒/ns)
----

初始化 dobbo provider 时的 URL
[source,plain]
----
# org.apache.dubbo.common.threadpool.manager.IsolationExecutorRepository#createExecutor

dubbo://30.170.132.110:20880/com.alibaba.dangqian.HiService?anyhost=true&application=unknown&background=false&bind.ip=30.170.132.110&bind.port=20880&channel.readonly.sent=true&codec=dubbo&deprecated=false&dubbo=2.0.2&dynamic=true&enable-empty-protection=true&executor-management-mode=isolation&file-cache=true&generic=false&group=HSF&heartbeat=60000&interface=com.alibaba.dangqian.HiService&methods=sayHello,sayHi&pid=42420&prefer.serialization=hessian2,fastjson2&release=3.3.3&revision=1.0.2-SNAPSHOT&service-name-mapping=true&side=provider&threadname=DubboServerHandler-30.170.132.110:20880&timeout=100&timestamp=1747315536723&version=1.0.0

tri://192.168.10.125:50051/com.alibaba.dangqian.HiService?anyhost=true&application=unknown&background=false&bind.ip=192.168.10.125&bind.port=50051&deprecated=false&dubbo=2.0.2&dynamic=true&enable-empty-protection=true&executor-management-mode=isolation&file-cache=true&generic=false&group=HSF&interface=com.alibaba.dangqian.HiService&methods=sayHello,sayHi&pid=6783&prefer.serialization=hessian2,fastjson2&release=3.3.3&revision=1.0.2-SNAPSHOT&service-name-mapping=true&side=provider&threadname=DubboServerHandler-192.168.10.125:50051&threads=333&timeout=100&timestamp=1747329373016&version=1.0.0
----

[source,plain]
----
# 启动时，初始化好 DoubboConfig
DubboBootstrap.getInstance().start()
  org.apache.dubbo.config.deploy.DefaultApplicationDeployer#initialize
    org.apache.dubbo.config.deploy.DefaultApplicationDeployer#loadApplicationConfigs
      org.apache.dubbo.config.context.ConfigManager#loadConfigs
        #refreshAll
          org.apache.dubbo.config.AbstractConfig#refresh
            #refreshWithPrefixes   # preferredPrefix="dubbo.protocols.dubbo"
                                   # 多种配置合并
              org.apache.dubbo.common.config.Environment#getConfigurationMaps()  # jvm属性,环境变量,appExternal,external,appConfig,DoubboConfig
                org.apache.dubbo.config.context.ConfigConfigurationAdapter#<init>
                  #getMetaData
                    #appendAttributes
              #assignProperties  # 将多种配置合并后，重新赋值到当前的 DoubboConfig 对象上
# 声明dubbo provider时
org.apache.dubbo.config.ServiceConfig#export()
  #doExport()
    #doExportUrls
      #doExportUrlsFor1Protocol
        #buildAttributes  # 为 service provider url 准备相关参数map
          org.apache.dubbo.config.AbstractConfig#appendParameters(Map, ProtocolConfig)  # 将ProtocolConfig的值暴露到map里
        #buildUrl  # 构建 service provider url
          org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository#createExecutorIfAbsent
            #createExecutor
              org.apache.dubbo.common.threadpool.support.fixed.FixedThreadPool#getExecutor
        #exportUrl
          org.apache.dubbo.rpc.protocol.tri.TripleProtocol#export
            org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository#createExecutorIfAbsent
              org.apache.dubbo.common.threadpool.support.fixed.FixedThreadPool#getExecutor
----

[source,shell]
----
org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository#data

#extensionLoader=#applicationModel.getExtensionDirector().getExtensionLoader(@org.apache.dubbo.common.threadpool.manager.ExecutorRepository@class),
#executorRepository=#extensionLoader.getExtension("isolation")

# key1 : "java.util.concurrent.ExecutorService"
#  key11: "50051", "20880","unknown/org.apache.dubbo.metadata.MetadataServiceV2:2.0.0","unknown/org.apache.dubbo.metadata.MetadataService:1.0.0",
#  value11 : ThreadPoolExecutor


# HSF 使用的这个类
org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository#data

org.apache.dubbo.common.threadpool.manager.IsolationExecutorRepository

vmtool -x 3 --action getInstances --className org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository --express 'instances.{#this.getClass().getName()}'


# 实际的类型也是 IsolationExecutorRepository
vmtool -x 3 --action getInstances --className org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository --express 'instances.{#this.getClass().getName()}'

# 应该是 triple 协议+dubbo协议各自开了两个 fixed 的线程池
vmtool -x 3 --action getInstances --className org.apache.dubbo.common.threadpool.manager.IsolationExecutorRepository --express 'instances.length'
vmtool -x 3 --action getInstances --className org.apache.dubbo.common.threadpool.manager.IsolationExecutorRepository --express 'instances.{#this.getClass().getName()}'

vmtool -x 3 --action getInstances --className org.apache.dubbo.common.threadpool.manager.IsolationExecutorRepository --express 'instances.{?#this.data.size()>0}.{#this.data.keySet()}'

# 检查实际运行的信息
vmtool -x 3 --action getInstances --className org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository  --express '
instances
.{?#this.data.size()>0}
.{
  #this.data["java.util.concurrent.ExecutorService"].entrySet()
   .{? #this.getKey() == "50051" || #this.getKey() == "20880" }
   .{
      #{
        "port"              : #this.getKey(),
        "corePoolSize"      : #this.getValue().corePoolSize,
        "maximumPoolSize"   : #this.getValue().maximumPoolSize,
        "keepAliveTime"     : #this.getValue().keepAliveTime
      }
    }
}[0]
'

vmtool -x 3 --action getInstances --className org.apache.dubbo.common.threadpool.manager.DefaultExecutorRepository  --express '
instances
.{?#this.data.size()>0}
.{#this.data.keySet()}
'

# JVM 属性
-Ddubbo.protocol.threads=500    # 对所有协议生效，比如: dubbo,tri
-Ddubbo.protocols.dubbo.threads=500  # 对单个协议生效
-Ddubbo.protocols.tri.threads=600    # 对单个协议生效
----

podman run --rm -it \
 --platform=linux/amd64 \
 -p 8848:8848 -p 9848:9848 -p 9849:9849 -p 7848:7848 \
 -e MODE=standalone \
 -e NACOS_AUTH_IDENTITY_KEY=nacos \
 -e NACOS_AUTH_IDENTITY_VALUE=nacos \
 -e NACOS_AUTH_TOKEN=SecretKey012345678901234567890123456789012345678901234567890123456789 \
 o-docker.alibaba-inc.com/docker.io/nacos-server:v2.5.1

-ea -Ddubbo.registry.address=nacos://nacos:nacos@127.0.0.1:8848
-ea -Ddubbo.registry.address=nacos://nacos:nacos@127.0.0.1:8848 -Ddubbo.protocol.threads=333
-Ddubbo.registry.address=nacos://127.0.0.1:8848 -Dgong9.mw.dubbo.jackson.type.whitelist=com.alibaba.fastjson





:table-caption: fix
[,cols="1,2"]
.table1 title
|===
|prop       | fix

|threads    | Y,200,ThreadPoolExecutor#corePoolSize,ThreadPoolExecutor#maximumPoolSize
|queues     | Y,0, 小于0:MemorySafeLinkedBlockingQueue,等于0:SynchronousQueue,大于0:LinkedBlockingQueue

|===

:table-caption: cache
[,cols="1,2"]
.table1 title
|===
|prop       | cache

|threads    | Y,Integer.MAX_VALUE,ThreadPoolExecutor#corePoolSize,ThreadPoolExecutor#maximumPoolSize
|queues     | Y,0, 小于0:MemorySafeLinkedBlockingQueue,等于0:SynchronousQueue,大于0:LinkedBlockingQueue
|corethreads| Y,0, 小于0:MemorySafeLinkedBlockingQueue,等于0:SynchronousQueue,大于0:LinkedBlockingQueue
|alive      | Y,60000
|===

:table-caption: Eager
[,cols="1,2"]
.table1 title
|===
|prop       | Eager

|threads    | Y,Integer.MAX_VALUE,ThreadPoolExecutor#corePoolSize,ThreadPoolExecutor#maximumPoolSize
|queues     | Y,0, 小于0:MemorySafeLinkedBlockingQueue,等于0:SynchronousQueue,大于0:LinkedBlockingQueue
|corethreads| Y,0, 小于0:MemorySafeLinkedBlockingQueue,等于0:SynchronousQueue,大于0:LinkedBlockingQueue
|alive      | Y,60000
|===

:table-caption: limited
[,cols="1,2"]
.table1 title
|===
|prop       | limited

|threads    | Y,200,ThreadPoolExecutor#corePoolSize,ThreadPoolExecutor#maximumPoolSize
|queues     | Y,0, 小于0:MemorySafeLinkedBlockingQueue,等于0:SynchronousQueue,大于0:LinkedBlockingQueue
|corethreads| Y,0, 小于0:MemorySafeLinkedBlockingQueue,等于0:SynchronousQueue,大于0:LinkedBlockingQueue
|===



== 获取发布的服务列表


[source,shell]
----
# @see org.apache.dubbo.qos.command.impl.Ls
sc -d org.apache.dubbo.config.bootstrap.DubboBootstrap
ognl -c 4a83a74a '
#dubboBootstrap=@org.apache.dubbo.config.bootstrap.DubboBootstrap@getInstance(),
#applicationModel=#dubboBootstrap.getApplicationModel(),
#frameworkModel=#applicationModel.getFrameworkModel(),
#providerModels=#frameworkModel.getServiceRepository().allProviderModels(),
#providerModels.{ #{"serviceKey": #this.serviceKey, "serviceUrls": #this.serviceUrls} }
' -x 3
----

== 获取使用的注册中心列表

[source,shell]
----
# 获取有多少个注册中心
sc -d org.apache.dubbo.config.bootstrap.DubboBootstrap
ognl -c 4a83a74a '
#dubboBootstrap=@org.apache.dubbo.config.bootstrap.DubboBootstrap@getInstance(),
#configManager=#dubboBootstrap.getConfigManager(),
#configManager.configsCache
' -x 3
----


== Q: 多classloader 的情况下，dubbo 从哪个classloader 查找扩展点？

[source,plain]
----
# 加载扩展点 class
org.apache.dubbo.common.extension.ExtensionLoader#loadExtensionClasses
  #loadDirectory
    #loadDirectoryInternal

    // 1. 如果 loadingStrategy.preferExtensionClassLoader()==true (自带实现均是false)
    //    且 ExtensionLoader.class.getClassLoader() != ClassLoader.getSystemClassLoader() 时,
    //    则优先使用 ExtensionLoader.class 所在的 classloader.
    // 2.1 如果要加载的 dubbo 内部 "special_spi.properties" 记录的类型，则【仅】使用 ExtensionLoader.class 所在的 classloader.
    // 2.2 否则，继续使用 scopeModel.getClassLoaders(),
    //     但如果 scopeModel.getClassLoaders() 是空值，则 从 ClassLoader.getSystemResources(fileName) 查找 文件并加载类。
    

org.apache.dubbo.rpc.model.ScopeModel#classLoaders
  // FrameworkModel,ApplicationModel,ModuleModel
  // 1. 优先使用 ScopeModel.class.getClassLoader() , 即dubbo 框架所在的 classloader




# 创建/加载扩展点 对象
org.apache.dubbo.rpc.cluster.filter.DefaultFilterChainBuilder#buildInvokerChain  中去加载 Filter 扩展点。
org.apache.dubbo.rpc.model.ScopeModelUtil#getExtensionLoader :


----

== Q: 同JVM调用时，dubbo转换为 injvm 调用的位置是？

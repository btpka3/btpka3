

* link:https://docs.docker.com/desktop/cert-revoke-solution/[Resolve the recent Docker Desktop issue on macOS]
å¦‚æœå‡ºç°è¿™ä¸ª å¼¹æ¡†æŠ¥é”™ : "Malware Blocked: â€œcom.docker.vmnetdâ€ was not opened because it contains malware", åˆ™æŒ‰ç…§è¯¥æµç¨‹èµ°ä¸€éã€‚

## å®‰è£…

[source,shell]
----
# å¦‚æœMacOSä¸Šå®‰è£…åå¯åŠ¨ä¸èµ·æ¥ï¼Œè¯·å‚è€ƒä¸‹è½½ä½¿ç”¨è¿™é‡Œæç¤ºçš„ç‰ˆæœ¬ã€‚æ¯”å¦‚ï¼š
# æ¯”å¦‚: 2024-05-16, å®‰è£… 4.30.0 ç‰ˆæœ¬çš„ Mac with Intel chip ç‰ˆæœ¬å°±å¯åŠ¨ä¸èµ·æ¥ï¼Œé€€å›æˆ 4.26.0 ç‰ˆæœ¬å°±å¥½äº†ã€‚
brew info docker

#brew install --cask docker
#brew uninstall docker

# ä¸‹è½½ Docker.dmg å
vi ~/.zshrc  # å¢åŠ ä»¥ä¸‹é…ç½®
export PATH="${HOME}/.docker/bin:${PATH}"


# å¯åŠ¨å¼‚å¸¸è¯Šæ–­
/Applications/Docker.app/Contents/MacOS/com.docker.diagnose check
ll /usr/local/bin/dock*
ll ~/Library/Containers/com.docker.*
ll ~/Library/Containers/com.docker.docker/Data/log/host/

/Applications/Docker.app/Contents/Resources/bin/docker system prune --all --force
----

## æŸ¥çœ‹æ–‡ä»¶å†…å®¹

* æ–¹å¼1ï¼š é€šè¿‡docker descktop æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ container é‡Œçš„æ–‡ä»¶
* æ–¹å¼2ï¼š é€šè¿‡ `docker cp` å‘½ä»¤æ¥æ£€æŸ¥dockeré•œåƒæœ€ç»ˆçš„æŸä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚ç¤ºä¾‹ï¼š

[source,shell]
----
DOCKER_IMAGE=docker.io/otel/opentelemetry-collector-contrib:0.96.0
FILE_IN_IMAGE=//etc/otelcol-contrib/config.yaml

# æ‹‰å–æœ€æ–°Dockeré•œåƒ
docker pull ${DOCKER_IMAGE}
# åˆ›å»ºä¸´æ—¶ docker å®¹å™¨
id=$(docker create ${DOCKER_IMAGE})
# ä» docker å®¹å™¨ä¸­ copy æ–‡ä»¶åˆ° å½“å‰ç›®å½•
cur_dir=$(pwd)
rm -fr /tmp/a
mkdir -p /tmp/a
cd /tmp/a
docker cp $id:${FILE_IN_IMAGE} .
# åˆ é™¤ä¸´æ—¶ docker å®¹å™¨
docker rm -v $id
cd ${cur_dir}
----




## ~/.docker/config.json

- link:https://docs.docker.com/engine/reference/commandline/cli/#docker-cli-configuration-file-configjson-properties[Docker CLI configuration file (config.json) properties]
- link:https://docs.docker.com/engine/reference/commandline/login/#credential-stores[Credential stores]
- link:https://www.passwordstore.org/[pass]

[source,shell]
----
brew install pass
----



`docker login` å¦‚æœè¿™ä¸ªé”™è¯¯ï¼Œåˆ™ä¿®æ”¹ `vi ~/.docker/config.json` åˆ é™¤ "credsStore"

[source,plain]
----
Error saving credentials: error storing credentials - err: exit status 1, out: `status code not OK but 500: {"message":"Post \"https://hub.docker.com/v2/users/login?refresh_token=true\": EOF"}
{"message":"Post \"https://hub.docker.com/v2/users/login?refresh_token=true\": EOF"}`
----

[source,shell]
----
{
  "credsStore": "osxkeychain"
}
----


## /etc/docker/daemon.json
## ~/.docker/daemon.json



## é•œåƒæº

[source,shell]
----
# å®‰è£… chsrc
brew install chsrc
# åˆ—å‡º docker hub çš„ é•œåƒæº
chsrc list docker
----

MacOS çš„ Docker desktop ï¼š Settings / Docker Engine è¿›è¡Œé…ç½®ï¼š

[source,json]
----
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "registry-mirrors": [
    "https://docker.1panel.live",
    "https://docker.m.daocloud.io",
    "https://huecker.io"
  ]
}
----

## mirror - é•œåƒåŠ é€Ÿ

|mirror domain                 |status  |mirror providr | desc|
|------------------------------|--------|------------|---------|
| <youId>.mirror.aliyuncs.com  |âœ…      |é˜¿é‡Œäº‘       ||
| hub-mirror.c.163.com         |âœ…      |ç½‘æ˜“         ||
| dockerproxy.com              |âœ…      |Docker Proxy||
| 05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com              |âœ…      |åä¸ºäº‘|https://support.huaweicloud.com/usermanual-swr/swr_01_0045.html|


| mirror.baidubce.com          |ğŸš«      |ç™¾åº¦         |https://cloud.baidu.com/doc/CCE/s/Yjxppt74z|ä¸ç¨³å®š|
| docker.mirrors.ustc.edu.cn   |ğŸš«      |ä¸­ç§‘å¤§       |ä¸å¯ç”¨|
| ccr.ccs.tencentyun.com       |ğŸš«      |è…¾è®¯         |ä¸å¯ç”¨|


- âœ… é˜¿é‡Œäº‘
    - åŠ é€ŸåŸŸå: `<youId>.mirror.aliyuncs.com`
    - ç¤ºä¾‹å€¼: `3ibg8tk1.mirror.aliyuncs.com`
    - è¯´æ˜æ–‡æ¡£ï¼šé˜¿é‡Œäº‘: å®¹å™¨é•œåƒæœåŠ¡ ACR : é¦–é¡µ>å®¹å™¨é•œåƒæœåŠ¡ ACR>é•œåƒå·¥å…·>å®˜æ–¹é•œåƒåŠ é€Ÿ : [å®˜æ–¹é•œåƒåŠ é€Ÿ](https://help.aliyun.com/document_detail/60750.html)

- âœ… ç½‘æ˜“
    - åŠ é€ŸåŸŸå: `hub-mirror.c.163.com`
- âœ… Docker Proxy
    - åŠ é€ŸåŸŸå: `dockerproxy.com`
- âœ… åä¸ºäº‘
    - åŠ é€ŸåŸŸå: `<xxx>.mirror.swr.myhuaweicloud.com`
    - ç¤ºä¾‹å€¼: `05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com`
    - è¯´æ˜æ–‡æ¡£ï¼š https://support.huaweicloud.com/usermanual-swr/swr_01_0045.html
- ğŸš« ç™¾åº¦
    - åŠ é€ŸåŸŸå: `mirror.baidubce.com`, ä¸ç¨³å®š
    - è¯´æ˜æ–‡æ¡£ï¼š https://cloud.baidu.com/doc/CCE/s/Yjxppt74z|ä¸ç¨³å®š
- ğŸš« ä¸­ç§‘å¤§
    - åŠ é€ŸåŸŸå: `docker.mirrors.ustc.edu.cn`, ä¸å¯ç”¨
- ğŸš« è…¾è®¯äº‘
    - åŠ é€ŸåŸŸå: `ccr.ccs.tencentyun.com`, ä¸å¯ç”¨





[source,shell]
----
# ä» docker hub æ‹‰å–é•œåƒçš„å®Œæ•´å‘½ä»¤
podman pull docker.io/library/alpine:latest

# éªŒè¯ä½¿ç”¨é•œåƒæ‹‰å–
MIRROR=05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com
podman pull ${MIRROR}/library/alpine:latest

podman pull ccr.ccs.tencentyun.com/library/alpine:latest
----


## ä»£ç†
å‚è€ƒ link:tinyproxy.adoc[tinyproxy]

æ³¨æ„ï¼šç”±äºmacosä¸Šçš„docker engine å®é™…ä¹Ÿæ˜¯è¿è¡Œåœ¨ä¸€ä¸ªé•œåƒé‡Œçš„ï¼Œæ•…ä»£ç†æœåŠ¡å™¨åœ°å€ä¸èƒ½æ˜¯ 127.0.0.1ï¼Œè¿™é‡Œçš„30.166.33.108å°±æ˜¯ä¸ªäººç”µè„‘ï¼ˆå®¿ä¸»æœºï¼‰çš„å±€åŸŸç½‘IPã€‚

[source,json]
----
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "proxies": {
    "http-proxy": "http://30.166.33.108:13660",
    "https-proxy": "http://30.166.33.108:13660",
    "no-proxy": "*.test.example.com,.example.org"
  }
}
----


## tag

[source,shell]
----
docker image tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]
docker image push IMAGE[:TAG]
----

## Manifest
* Docker Image Manifest V1 : âŒ å·²åºŸå¼ƒã€‚ 2017-02-28, Docker v1.13å¼€å§‹ä¸å†æ”¯æŒ
* Docker Image Manifest V2 Schema1 : âŒ å·²åºŸå¼ƒã€‚
  ä¸´æ—¶ç‰ˆæœ¬ï¼Œä¸”å…¼å®¹V1ã€‚
* Docker Image Manifest V2 Schema2 :
  æ”¯æŒå¤šæ¶æ„ï¼Œå¯å†…å®¹å¯»å€ã€‚
  å¯ä»¥é€šè¿‡ docker pull, docker push å³å¯å‡çº§åˆ°æ–°ç‰ˆæœ¬ã€‚
  "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
  "mediaType": "application/vnd.docker.container.image.v1+json",
  "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",

* OCI æ ¼å¼ï¼š åŸºäº Docker Image Manifest V2 Schema 2 æ”¹é€ ã€‚
  "mediaType": "application/vnd.oci.image.manifest.v1+json"
  "mediaType": "application/vnd.oci.image.config.v1+json"
  "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",




* link:https://docs.docker.com/desktop/cert-revoke-solution/[Resolve the recent Docker Desktop issue on macOS]
å¦‚æœå‡ºç°è¿™ä¸ª å¼¹æ¡†æŠ¥é”™ : "Malware Blocked: â€œcom.docker.vmnetdâ€ was not opened because it contains malware", åˆ™æŒ‰ç…§è¯¥æµç¨‹èµ°ä¸€éã€‚

## å®‰è£…

[source,shell]
----
# å¦‚æœMacOSä¸Šå®‰è£…åå¯åŠ¨ä¸èµ·æ¥ï¼Œè¯·å‚è€ƒä¸‹è½½ä½¿ç”¨è¿™é‡Œæç¤ºçš„ç‰ˆæœ¬ã€‚æ¯”å¦‚ï¼š
# æ¯”å¦‚: 2024-05-16, å®‰è£… 4.30.0 ç‰ˆæœ¬çš„ Mac with Intel chip ç‰ˆæœ¬å°±å¯åŠ¨ä¸èµ·æ¥ï¼Œé€€å›æˆ 4.26.0 ç‰ˆæœ¬å°±å¥½äº†ã€‚
brew info docker

#brew install --cask docker
#brew uninstall docker

# ä¸‹è½½ Docker.dmg å
vi ~/.zshrc  # å¢åŠ ä»¥ä¸‹é…ç½®
export PATH="${HOME}/.docker/bin:${PATH}"


# å¯åŠ¨å¼‚å¸¸è¯Šæ–­
/Applications/Docker.app/Contents/MacOS/com.docker.diagnose check
ll /usr/local/bin/dock*
ll ~/Library/Containers/com.docker.*
ll ~/Library/Containers/com.docker.docker/Data/log/host/

/Applications/Docker.app/Contents/Resources/bin/docker system prune --all --force
----

## æŸ¥çœ‹æ–‡ä»¶å†…å®¹

* æ–¹å¼1ï¼š é€šè¿‡docker descktop æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ container é‡Œçš„æ–‡ä»¶
* æ–¹å¼2ï¼š é€šè¿‡ `docker cp` å‘½ä»¤æ¥æ£€æŸ¥dockeré•œåƒæœ€ç»ˆçš„æŸä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚ç¤ºä¾‹ï¼š

[source,shell]
----
# å¯ç”¨äºå°†ä¸å«æ“ä½œç³»ç»Ÿï¼Œåªå«æ™®é€šç›®å½•ã€æ–‡ä»¶çš„ dockeré•œåƒå†…copyæ–‡ä»¶åˆ°host
DOCKER_IMAGE=docker.io/otel/opentelemetry-collector-contrib:0.96.0
FILE_IN_IMAGE=//etc/otelcol-contrib/config.yaml

# æ‹‰å–æœ€æ–°Dockeré•œåƒ
docker pull ${DOCKER_IMAGE}
# åˆ›å»ºä¸´æ—¶ docker å®¹å™¨
id=$(docker create ${DOCKER_IMAGE})
# ä» docker å®¹å™¨ä¸­ copy æ–‡ä»¶åˆ° å½“å‰ç›®å½•
cur_dir=$(pwd)
rm -fr /tmp/a
mkdir -p /tmp/a
cd /tmp/a
docker cp $id:${FILE_IN_IMAGE} .
# åˆ é™¤ä¸´æ—¶ docker å®¹å™¨
docker rm -v $id
cd ${cur_dir}
----




## ~/.docker/config.json

- link:https://docs.docker.com/engine/reference/commandline/cli/#docker-cli-configuration-file-configjson-properties[Docker CLI configuration file (config.json) properties]
- link:https://docs.docker.com/engine/reference/commandline/login/#credential-stores[Credential stores]
- link:https://www.passwordstore.org/[pass]

[source,shell]
----
brew install pass
----



`docker login` å¦‚æœè¿™ä¸ªé”™è¯¯ï¼Œåˆ™ä¿®æ”¹ `vi ~/.docker/config.json` åˆ é™¤ "credsStore"

[source,plain]
----
Error saving credentials: error storing credentials - err: exit status 1, out: `status code not OK but 500: {"message":"Post \"https://hub.docker.com/v2/users/login?refresh_token=true\": EOF"}
{"message":"Post \"https://hub.docker.com/v2/users/login?refresh_token=true\": EOF"}`
----

[source,shell]
----
{
  "credsStore": "osxkeychain"
}
----


## /etc/docker/daemon.json
## ~/.docker/daemon.json



## é•œåƒæº

[source,shell]
----
# å®‰è£… chsrc
brew install chsrc
# åˆ—å‡º docker hub çš„ é•œåƒæº
chsrc list docker
----

MacOS çš„ Docker desktop ï¼š Settings / Docker Engine è¿›è¡Œé…ç½®ï¼š

[source,json]
----
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "registry-mirrors": [
    "https://docker.1panel.live",
    "https://docker.m.daocloud.io",
    "https://huecker.io"
  ]
}
----

## mirror - é•œåƒåŠ é€Ÿ

|mirror domain                 |status  |mirror providr | desc|
|------------------------------|--------|------------|---------|
| <youId>.mirror.aliyuncs.com  |âœ…      |é˜¿é‡Œäº‘       ||
| hub-mirror.c.163.com         |âœ…      |ç½‘æ˜“         ||
| dockerproxy.com              |âœ…      |Docker Proxy||
| 05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com              |âœ…      |åä¸ºäº‘|https://support.huaweicloud.com/usermanual-swr/swr_01_0045.html|


| mirror.baidubce.com          |ğŸš«      |ç™¾åº¦         |https://cloud.baidu.com/doc/CCE/s/Yjxppt74z|ä¸ç¨³å®š|
| docker.mirrors.ustc.edu.cn   |ğŸš«      |ä¸­ç§‘å¤§       |ä¸å¯ç”¨|
| ccr.ccs.tencentyun.com       |ğŸš«      |è…¾è®¯         |ä¸å¯ç”¨|


- âœ… é˜¿é‡Œäº‘
    - åŠ é€ŸåŸŸå: `<youId>.mirror.aliyuncs.com`
    - ç¤ºä¾‹å€¼: `3ibg8tk1.mirror.aliyuncs.com`
    - è¯´æ˜æ–‡æ¡£ï¼šé˜¿é‡Œäº‘: å®¹å™¨é•œåƒæœåŠ¡ ACR : é¦–é¡µ>å®¹å™¨é•œåƒæœåŠ¡ ACR>é•œåƒå·¥å…·>å®˜æ–¹é•œåƒåŠ é€Ÿ : [å®˜æ–¹é•œåƒåŠ é€Ÿ](https://help.aliyun.com/document_detail/60750.html)

- âœ… ç½‘æ˜“
    - åŠ é€ŸåŸŸå: `hub-mirror.c.163.com`
- âœ… Docker Proxy
    - åŠ é€ŸåŸŸå: `dockerproxy.com`
- âœ… åä¸ºäº‘
    - åŠ é€ŸåŸŸå: `<xxx>.mirror.swr.myhuaweicloud.com`
    - ç¤ºä¾‹å€¼: `05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com`
    - è¯´æ˜æ–‡æ¡£ï¼š https://support.huaweicloud.com/usermanual-swr/swr_01_0045.html
- ğŸš« ç™¾åº¦
    - åŠ é€ŸåŸŸå: `mirror.baidubce.com`, ä¸ç¨³å®š
    - è¯´æ˜æ–‡æ¡£ï¼š https://cloud.baidu.com/doc/CCE/s/Yjxppt74z|ä¸ç¨³å®š
- ğŸš« ä¸­ç§‘å¤§
    - åŠ é€ŸåŸŸå: `docker.mirrors.ustc.edu.cn`, ä¸å¯ç”¨
- ğŸš« è…¾è®¯äº‘
    - åŠ é€ŸåŸŸå: `ccr.ccs.tencentyun.com`, ä¸å¯ç”¨





[source,shell]
----
# ä» docker hub æ‹‰å–é•œåƒçš„å®Œæ•´å‘½ä»¤
podman pull docker.io/library/alpine:latest

# éªŒè¯ä½¿ç”¨é•œåƒæ‹‰å–
MIRROR=05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com
podman pull ${MIRROR}/library/alpine:latest

podman pull ccr.ccs.tencentyun.com/library/alpine:latest
----


## ä»£ç†
å‚è€ƒ link:tinyproxy.adoc[tinyproxy]

æ³¨æ„ï¼šç”±äºmacosä¸Šçš„docker engine å®é™…ä¹Ÿæ˜¯è¿è¡Œåœ¨ä¸€ä¸ªé•œåƒé‡Œçš„ï¼Œæ•…ä»£ç†æœåŠ¡å™¨åœ°å€ä¸èƒ½æ˜¯ 127.0.0.1ï¼Œè¿™é‡Œçš„30.166.33.108å°±æ˜¯ä¸ªäººç”µè„‘ï¼ˆå®¿ä¸»æœºï¼‰çš„å±€åŸŸç½‘IPã€‚

[source,json]
----
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "proxies": {
    "http-proxy": "http://30.166.33.108:13660",
    "https-proxy": "http://30.166.33.108:13660",
    "no-proxy": "*.test.example.com,.example.org"
  }
}
----


## tag

[source,shell]
----
docker image tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]
docker image push IMAGE[:TAG]
----

## Manifest
* Docker Image Manifest V1 : âŒ å·²åºŸå¼ƒã€‚ 2017-02-28, Docker v1.13å¼€å§‹ä¸å†æ”¯æŒ
* Docker Image Manifest V2 Schema1 : âŒ å·²åºŸå¼ƒã€‚
  ä¸´æ—¶ç‰ˆæœ¬ï¼Œä¸”å…¼å®¹V1ã€‚
* Docker Image Manifest V2 Schema2 :
  æ”¯æŒå¤šæ¶æ„ï¼Œå¯å†…å®¹å¯»å€ã€‚
  å¯ä»¥é€šè¿‡ docker pull, docker push å³å¯å‡çº§åˆ°æ–°ç‰ˆæœ¬ã€‚
  "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
  "mediaType": "application/vnd.docker.container.image.v1+json",
  "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",

* OCI æ ¼å¼ï¼š åŸºäº Docker Image Manifest V2 Schema 2 æ”¹é€ ã€‚
  "mediaType": "application/vnd.oci.image.manifest.v1+json"
  "mediaType": "application/vnd.oci.image.config.v1+json"
  "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",



== build multi-platform images





== Sidecar
Sidecar å®¹å™¨ä¸ä¸»åº”ç”¨å®¹å™¨ç´§å¯†å…³è”ã€è¿è¡Œåœ¨åŒä¸€ Pod ä¸­çš„è¾…åŠ©å®¹å™¨ï¼Œå…¶æ ¸å¿ƒä½œç”¨æ˜¯ä¸ºä¸»ä½“åº”ç”¨æä¾›å„ç±»æ”¯æ’‘æ€§æœåŠ¡ï¼Œä¸”æ— éœ€ä¿®æ”¹ä¸»åº”ç”¨çš„ä»£ç é€»è¾‘ï¼Œå®ç° â€œåŠŸèƒ½è§£è€¦â€ ä¸ â€œèƒ½åŠ›æ‰©å±•â€ çš„åŒé‡ç›®æ ‡ã€‚å…·ä½“è€Œè¨€ï¼ŒSidecar å®¹å™¨å¯æ‰¿æ‹…ä»¥ä¸‹å‡ ç±»å…³é”®è§’è‰²ï¼š

* æ—¥å¿—æ”¶é›†ï¼šé€šè¿‡å…±äº«æ–‡ä»¶ç³»ç»Ÿæ•°æ®å·ï¼Œä¸šåŠ¡ä¸»å®¹å™¨è´Ÿè´£å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œsidecarå®¹å™¨è´Ÿè´£è¯»å–æ—¥å¿—æ–‡ä»¶
* ç›‘æ§: Prometheus Exporter ç­‰åœ¨ sidecar å®¹å™¨å¯åŠ¨æœåŠ¡ç«¯å£ï¼Œä¸šåŠ¡ä¸»å®¹å™¨å‘è¯¥ç«¯å£ä¸ŠæŠ¥ç›‘æ§æŒ‡æ ‡æ•°æ®
* ä»£ç†: Envoy ä»£ç†ä¸šåŠ¡ä¸»å®¹å™¨çš„ç½‘ç»œï¼Œå¤„ç†æµé‡æ‹¦æˆªã€åŠ å¯†ã€åè®®è½¬æ¢ï¼ˆHTTP ä¸ gRPC è½¬æ¢ç­‰ï¼‰ï¼Œç®€åŒ–ä¸»åº”ç”¨çš„ç½‘ç»œé€šä¿¡é€»è¾‘ã€‚

* æœåŠ¡ç½‘æ ¼é›†æˆï¼šä½œä¸º Service Mesh æ¶æ„çš„æ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ Istioã€Linkerd ä¸­çš„ Proxy å®¹å™¨ï¼‰ï¼Œè´Ÿè´£æ‹¦æˆªä¸»åº”ç”¨çš„ç½‘ç»œæµé‡ï¼Œå®ç°æµé‡æ§åˆ¶ã€æœåŠ¡å‘ç°ã€ç†”æ–­é™çº§ã€ç°åº¦å‘å¸ƒç­‰ç½‘ç»œæ²»ç†åŠŸèƒ½ã€‚
* å¥åº·æ¢æ´»: ä¸»åŠ¨æ£€æŸ¥ä¸»åº”ç”¨æˆ–å…³è”ç»„ä»¶çš„è¿è¡ŒçŠ¶æ€ï¼Œå¦‚å®šæœŸå‘é€æ£€æµ‹è¯·æ±‚ã€ç›‘æ§ç«¯å£å¯ç”¨æ€§ç­‰ï¼ŒåŠæ—¶åé¦ˆå¼‚å¸¸çŠ¶æ€å¹¶è§¦å‘ç›¸åº”å¤„ç†æœºåˆ¶ã€‚
* è¾…åŠ©æ€§æ•°æ®æ“ä½œ: åŒ…æ‹¬ä½†ä¸é™äºä¸ºä¸»ä½“åº”ç”¨æ‹·è´é…ç½®æ–‡ä»¶ã€ä¸‹è½½ä¾èµ–èµ„æºã€åŒæ­¥æ•°æ®ç­‰ï¼Œå‡å°‘ä¸»åº”ç”¨åœ¨éä¸šåŠ¡é€»è¾‘ä¸Šçš„èµ„æºæ¶ˆè€—ã€‚

åœ¨ Kubernetes ä¸­ï¼ŒåŒä¸€ä¸ª Pod å†…çš„ä¸»å®¹å™¨ï¼ˆMain Containerï¼‰å’Œ Sidecar å®¹å™¨ å…±äº«åŒä¸€ä¸ª IP åœ°å€å’Œç½‘ç»œå‘½åç©ºé—´ã€‚

æ¯ä¸ª Pod æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IP åœ°å€ï¼Œè¯¥ IP ç”± Kubernetes çš„ç½‘ç»œæ’ä»¶ï¼ˆå¦‚ CNIï¼‰åˆ†é…ã€‚
æ‰€æœ‰å®¹å™¨å…±äº« Pod çš„ç½‘ç»œå‘½åç©ºé—´ï¼ŒåŒ…æ‹¬ï¼š

* åŒä¸€ä¸ª IP åœ°å€ã€‚
* åŒä¸€ä¸ªç«¯å£ç©ºé—´ï¼ˆå®¹å™¨é—´ä¸èƒ½ç»‘å®šç›¸åŒç«¯å£ï¼‰ã€‚podå†… ä¸šåŠ¡ä¸»å®¹å™¨å’Œsidecarå®¹å™¨é€šè¿‡ localhost:port çš„æ–¹å¼ç›¸äº’é€šä¿¡ï¼Œé€šè¿‡æ•°æ®å·å…±äº«æ•°æ®ã€‚
* åŒä¸€ç½‘ç»œè®¾å¤‡ï¼ˆå¦‚ eth0ï¼‰ã€‚

ä½†ä»¥ä¸‹èµ„æºä¸å…±äº«ï¼š

* è¿›ç¨‹ç©ºé—´
* æ–‡ä»¶ç³»ç»Ÿ
* å†…å­˜ç­‰


=== ç”¨ docker å¯ç”¨å…±äº«IPçš„ sidecar

åœ¨ Docker ä¸­ï¼Œå¯ä»¥é€šè¿‡ --network=container:<ä¸»å®¹å™¨å> è®©å¤šä¸ªå®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼ˆåŒ…æ‹¬ IP åœ°å€å’Œç«¯å£ç©ºé—´ï¼‰ï¼Œä»è€Œå®ç°ç±»ä¼¼ Kubernetes çš„ Sidecar å®¹å™¨å…±äº« IP çš„æ•ˆæœã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°æ–¹æ³•ï¼š
[source,shell]
----
# å¯åŠ¨ä¸»å®¹å™¨
docker run -d --name main-container your-main-image
# å¯åŠ¨ Sidecar å®¹å™¨å¹¶å…±äº«ä¸»å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´
docker run -d --name sidecar-container \
  --network container:main-container \
  your-sidecar-image

# æŸ¥çœ‹ä¸»å®¹å™¨çš„ IP
docker inspect --format='{{.NetworkSettings.IPAddress}}' main-container

# æŸ¥çœ‹ Sidecar å®¹å™¨çš„ IPï¼ˆä¸ä¸»å®¹å™¨ç›¸åŒï¼‰
docker inspect --format='{{.NetworkSettings.IPAddress}}' sidecar-container
----

=== ç”¨ docker-compose å¯ç”¨å…±äº«IPçš„ sidecar

[source,yaml]
----
version: '3'
services:
  main:
    image: main-app:latest
    ports:
      - "8080:8080"  # ä¸»å®¹å™¨æš´éœ²ç«¯å£

  sidecar:
    image: sidecar-app:latest
    network_mode: "service:main"  # å…±äº« main å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´
    depends_on:
      - main  # ç¡®ä¿ main å…ˆå¯åŠ¨
----





== docker in docker

- link:https://devopscube.com/run-docker-in-docker/[How To Run Docker in Docker Container [3 Easy Methods]]
- link:https://hub.docker.com/_/docker[_/docker]
- link:https://www.redhat.com/sysadmin/podman-inside-container[How to use Podman inside of a container]
- link:https://quay.io/repository/podman/stable[quay.io/podman/stable]

DinD (Docker in Docker)

[source,shell]
----
# å‡†å¤‡ç½‘ç»œ
docker network create       \
    -d bridge               \
    --gateway 192.168.1.1   \
    --subnet 192.168.1.0/24 \
    dockerNet

# å¯åŠ¨ daemon å®ä¾‹
docker run --privileged -it --rm \
           --network dockerNet --network-alias docker \
           -e DOCKER_TLS_CERTDIR=/certs \
           -v some-docker-certs-ca:/certs/ca \
           -v some-docker-certs-client:/certs/client \
           docker:latest
# Connect to it from a second container
docker run -it --rm --network dockerNet \
	-e DOCKER_TLS_CERTDIR=/certs \
	-v some-docker-certs-client:/certs/client:ro \
	docker:latest sh

# åœ¨ç¬¬äºŒä¸ªå®¹å™¨ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
docker version
docker run -it --rm docker.io/library/alpine:3.17.3 date
docker run -it --rm --entrypoint /bin/sh docker.io/library/alpine:3.17.3 -l
docker run -it --rm --entrypoint /bin/sh docker.io/library/alpine:3.17.3 -c date
----

== PinP(Podman in Podman)

link:https://quay.io/repository/podman/stable?tab=info[quay.io/podman/stable]

[source,shell]
----

#export PS1='\[\033[01;33m\]\u@\h\[\033[01;31m\] \W\$\[\033[00m\] '
podman run --security-opt label=disable --user podman \
  --device /dev/fuse quay.io/podman/stable \
  podman run alpine echo hello


podman run --privileged -it --rm quay.io/podman/stable sh

# åœ¨ docker å®¹å™¨å†…è¿è¡Œ

podman run --rm -it docker.io/alpine:latest echo aaa
podman run --rm -it o-docker.alibaba-inc.com/docker.io/alpine:3.21.3 echo aaa

----



- link:https://zookeeper.apache.org/doc/r3.9.3/zookeeperAdmin.html#sc_configuration[ZooKeeper Administrator's Guide]
- github link:https://github.com/apache/zookeeper[apache/zookeeper]

== install

[source,shell]
----
wget https://mirrors.aliyun.com/apache/zookeeper/zookeeper-3.9.4/apache-zookeeper-3.9.4-bin.tar.gz
----






== zoo.cfg



[source,shell]
----
# =========================== 最小配置项
# 每个tick的毫秒时间长度
tickTime=2000

# 客户端连接用的端口
clientPort=2181

# 使用SSL的客户端端口
#secureClientPort=

#
#observerMasterPort=

# 数据存储的目录
dataDir=/tmp/zookeeper

# =========================== 高级配置项

dataLogDir=
globalOutstandingLimit=     # jvm 属性 `zookeeper.globalOutstandingLimit`
preAllocSize=
snapCount=
commitLogCount=
snapSizeLimitInKb=
txnLogSizeLimitInKb=
maxCnxns=

# the maximum number of client connections.
# increase this if you need to handle more clients
maxClientCnxns=60
clientPortAddress=
minSessionTimeout=
maxSessionTimeout=
fsync.warningthresholdms=
maxResponseCacheSize=
maxGetChildrenResponseCacheSize=
autopurge.snapRetainCount=
autopurge.purgeInterval=
syncEnabled=
extendedTypesEnabled=
emulate353TTLNodes=
watchManagerName=
watcherCleanThreadsNum=
watcherCleanThreshold=
watcherCleanIntervalInSeconds=
maxInProcessingDeadWatchers=
bitHashCacheSize=
fastleader.minNotificationInterval=
fastleader.maxNotificationInterval=
connectionMaxTokens=
connectionTokenFillTime=
connectionTokenFillCount=
connectionFreezeTime=
connectionDropIncrease=
connectionDropDecrease=
connectionDecreaseRatio=
zookeeper.connection_throttle_weight_enabled=
zookeeper.connection_throttle_global_session_weight=
zookeeper.connection_throttle_local_session_weight=
zookeeper.connection_throttle_renew_session_weight=
clientPortListenBacklog=
serverCnxnFactory=
flushDelay=
maxWriteQueuePollTime=
maxBatchSize=
enforceQuota=
requestThrottleLimit=
requestThrottleStallTime=
requestThrottleDropStale=
requestStaleLatencyCheck=
requestStaleConnectionCheck=
zookeeper.request_throttler.shutdownTimeout=
advancedFlowControlEnabled=
enableEagerACLCheck=
maxConcurrentSnapSyncs=
maxConcurrentDiffSyncs=
digest.enabled=
snapshot.compression.method=
snapshot.trust.empty=
audit.enable=
audit.impl.class=
largeRequestMaxBytes=
largeRequestThreshold=
outstandingHandshake.limit=
netty.server.earlyDropSecureConnectionHandshakes=
throttledOpWaitTime=
learner.closeSocketAsync=
leader.closeSocketAsync=
learner.asyncSending=
forward_learner_requests_to_commit_processor_disabled=
serializeLastProcessedZxid.enabled=

# =========================== Cluster Options
electionAlg=
maxTimeToWaitForEpoch=

#ticks that the initial
# synchronization phase can take
initLimit=10
connectToLearnerMasterLimit=
leaderServes=
server.x=     # 格式: [hostname]:nnnnn[:nnnnn]

# The number of ticks that can pass between
# sending a request and getting an acknowledgement
syncLimit=5

group.x=   # 格式: nnnnn[:nnnnn]
cnxTimeout=
quorumCnxnTimeoutMs=-1
standaloneEnabled=
reconfigEnabled=
4lw.commands.whitelist=
tcpKeepAlive=
clientTcpKeepAlive=
electionPortBindRetry=
observer.reconnectDelayMs=
observer.election.DelayMs=
localSessionsEnabled=

# =========================== Encryption, Authentication, Authorization Options
DigestAuthenticationProvider.enabled=
DigestAuthenticationProvider.superDigest=
DigestAuthenticationProvider.digestAlg=
IPAuthenticationProvider.usexforwardedfor=
X509AuthenticationProvider.superUser=
zookeeper.superUser=
ssl.authProvider=
zookeeper.ensembleAuthName=
sessionRequireClientSASLAuth=
enforce.auth.enabled=
enforce.auth.schemes=
sslQuorum=
ssl.keyStore.location=
ssl.keyStore.passwordPath=
ssl.keyStore.type=
ssl.trustStore.location=
ssl.trustStore.passwordPath=
ssl.trustStore.type=
ssl.protocol=
ssl.enabledProtocols=
ssl.ciphersuites=
ssl.quorum.ciphersuites=
ssl.context.supplier.class=
ssl.quorum.context.supplier.class=
ssl.hostnameVerification=
ssl.quorum.hostnameVerification=
ssl.crl=
ssl.quorum.crl=
ssl.ocsp=
ssl.quorum.ocsp=
ssl.clientAuth=
ssl.quorum.clientAuth=
ssl.handshakeDetectionTimeoutMillis=
ssl.quorum.handshakeDetectionTimeoutMillis=
ssl.sslProvider=
sslQuorumReloadCertFiles=
client.certReload=
client.portUnification=
authProvider=
kerberos.removeHostFromPrincipal=
kerberos.removeRealmFromPrincipal=
kerberos.canonicalizeHostNames=
multiAddress.enabled=
multiAddress.reachabilityCheckTimeoutMs=
fips-mode=

# =========================== Experimental Options/Features
# jvm 属性 "readonlymode.enabled"

zookeeper.follower.skipLearnerRequestToNextProcessor=

# =========================== Unsafe Options

forceSync=
jute.maxbuffer=
jute.maxbuffer.extrasize=
skipACL=
quorumListenOnAllIPs=
multiAddress.reachabilityCheckEnabled=

# =========================== Disabling data directory autocreation
# =========================== Enabling db existence validation
# =========================== Performance Tuning Options
zookeeper.nio.numSelectorThreads=
zookeeper.nio.numWorkerThreads=
zookeeper.commitProcessor.numWorkerThreads=
zookeeper.commitProcessor.maxReadBatchSize=
zookeeper.commitProcessor.maxCommitBatchSize=
znode.container.checkIntervalMs=
znode.container.maxPerMinute=
znode.container.maxNeverUsedIntervalMs=

# =========================== Debug Observability Configurations
zookeeper.messageTracker.BufferSize=
zookeeper.messageTracker.Enabled=

# =========================== AdminServer configuration
admin.rateLimiterIntervalInMS=
admin.snapshot.enabled=
admin.restore.enabled=
admin.needClientAuth=
admin.forceHttps=
admin.portUnification=
admin.enableServer=true    # 是否开启 admin server. jvm 属性: `zookeeper.admin.enableServer`
admin.serverAddress=
admin.serverPort=8080
admin.idleTimeout=
admin.commandURL=

# =========================== Metrics Providers
metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
metricsProvider.httpHost=
metricsProvider.httpPort=7000
metricsProvider.exportJvmInfo=true
metricsProvider.numWorkerThreads=
metricsProvider.maxQueueSize=
metricsProvider.workerShutdownTimeoutMs=
----


== commands

可以通过 telnet 或者 nc 连接到 clientPort 并执行相应的 4个字母 的命令。

[source,shell]
----
echo ruok | nc localhost 2181
echo mntr | nc localhost 2181

# 如果返回类似  "ruok is not executed because it is not in the whitelist." 消息
# 则需要修改 配置项 : "4lw.commands.whitelist=stat, ruok, conf, isro"  # "*" 表示所有允许所有命令
----

== admin server

具体相关配置请参考配置项中 `admin.*`。
默认是 `http://localhost:8080/commands/*`


[source,shell]
----
ZK_ADMIN_SERVER_ADDR=localhost
ZK_ADMIN_SERVER_PORT=9090

# conf: 输出配置
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/conf | jq

# cons: 显示出连接到该服务器的 session/connection
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/cons | jq

# crst: ⚠️ 重置所有连接
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/crst | jq

# dump ：列出 outstanding sessions 和 ephemeral nodes， 仅对 leader 生效
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/dump | jq

# envi: 输出环境变量
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/envi | jq

# ruok: 检查服务器是否运行正常（OK）
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/ruok | jq

# srst: ⚠️ 重置服务器的统计信息
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/srst | jq

# srvr: 列出详细的服务器信息
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/srvr | jq

# stat: 列出服务器的简要信息和连接的client
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/stat | jq

# wchs: 列出 watch 信息
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/wchs | jq

# wchc: 按 session 列出 watch 详细信息
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/wchc | jq

# wchc: 按 path 列出 watch 详细信息
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/wchp | jq

# mntr: 列出集群健康监控的可用变量
curl -s http://${ZK_ADMIN_SERVER_ADDR}:${ZK_ADMIN_SERVER_PORT}/commands/mntr | jq

----


== zkCli.sh

[source,shell]
----
# 查看帮助文档
./bin/zkCli.sh help


ZK_ADDR=mse-b08b8562-zk.mse.aliyuncs.com
./bin/zkCli.sh -timeout 3000 -server ${ZK_ADDR}

# 创建持久节点
create /persistent_node

# 创建短暂节点
create -e /ephemeral_node mydata

# 创建 persistent-sequential 节点
create -s /persistent_sequential_node mydata

# create the container node.When the last child of a container is deleted,the container becomes to be deleted
create -c /container_node mydata

create /test
create /test/dangqian
set    /test/dangqian aaa
get    /test/dangqian

----

使用用户名、密码登录
[source,shell]
----

################### 服务器端配置
cp conf/zoo_sample.cfg  conf/zoo.cfg
# 增加以下配置，并重启zookeeper 服务器
vi conf/zoo.cfg

# 启用 Digest 认证
authProvider.1=org.apache.zookeeper.server.auth.DigestAuthenticationProvider
# 强制客户端使用 SASL 认证
#requireClientAuthScheme=sasl
#sessionRequireClientSASLAuth=true

#zookeeper.sasl.client=true
#zookeeper.sasl.clientconfig=Client
#zookeeper.sasl.client.username=xxxUser


################### 通过 zkCli.sh 创建 Digest 认证用户：
# 以管理员身份连接（无需密码）
./bin/zkCli.sh -server zk-host:2181

# 创建用户 "user1"，密码 "pass123"
create /authdigest user1:pass123  # 或使用 addauth digest 命令

################### 配置客户端的 JAAS 文件

cat <<EOF > /tmp/jaas.conf
Client {
  org.apache.zookeeper.server.auth.DigestLoginModule required
  username="user1"
  password="pass123";
};
EOF


CLIENT_JVMFLAGS="-Djava.security.auth.login.config=/tmp/jaas.conf -Dzookeeper.fips-mode=false" \
ZK_ADDR=mse-b08b8562-zk.mse.aliyuncs.com  \
./bin/zkCli.sh -timeout 3000 -server ${ZK_ADDR}
----



== arthas
[source,shell]
----
# 获取 使用的 zookeeper 的 connectString
vmtool -x 2 --action getInstances --className com.alibaba.security.mtee.sup.monitor.service.ZkClient --express '
#curator=instances[0].curatorFramework,
#zookeeper=#curator.getZookeeperClient().getZooKeeper(),
#zookeeper.cnxn.hostProvider.serverAddresses +""
'

# 获取 zookeeper 客户端 配置
# curatorFramework => zookeeper => zkClientConfig
vmtool -x 3 --action getInstances --className com.alibaba.security.mtee.sup.monitor.service.ZkClient --express '
#curator=instances[0].curatorFramework,
#zookeeper=#curator.getZookeeperClient().getZooKeeper(),
#zkClientConfig=#zookeeper.getClientConfig(),
#zkClientConfig.getProperty("zookeeper.sasl.clientconfig")
'

chrootPath
----






== 认证

[source,plain]
----
org.apache.zookeeper.server.auth.AuthenticationProvider
  org.apache.zookeeper.server.auth.SASLAuthenticationProvider
  org.apache.zookeeper.server.auth.EnsembleAuthenticationProvider
  org.apache.zookeeper.server.auth.IPAuthenticationProvider
  org.apache.zookeeper.server.auth.DigestAuthenticationProvider
  org.apache.zookeeper.server.auth.X509AuthenticationProvider
  org.apache.zookeeper.server.auth.ServerAuthenticationProvider
----


== zookeeper-contrib-zooinspector

link:https://github.com/apache/zookeeper/tree/master/zookeeper-contrib/zookeeper-contrib-zooinspector[zookeeper-contrib-zooinspector]

ZooInspector是一个基于Java Swing的zookeeper客户端程序。
main入口类: org.apache.zookeeper.inspector.ZooInspector


== Apache curator
link:https://curator.apache.org/[Apache curator]


[source,shell]
----

# 建议使用
org.apache.curator.framework.CuratorFramework
# CuratorZookeeperClient 是个低级API，不建议直接使用，建议使用
org.apache.curator.CuratorZookeeperClient
----



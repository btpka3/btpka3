

https://www.graalvm.org/22.0/reference-manual/native-image/Options/


* link:https://www.graalvm.org/22.1/reference-manual/native-image/DynamicProxy/[Dynamic Proxy in Native Image]

* link:https://www.graalvm.org/jdk24/reference-manual/native-image/overview/BuildConfiguration/[Native Image Build Configuration]
* link:https://www.graalvm.org/jdk24/reference-manual/native-image/overview/Options/[Command-line Options]

* link:https://graalvm.github.io/native-build-tools/latest/maven-plugin.html[Maven plugin for GraalVM Native Image building]
* link:https://www.graalvm.org/latest/reference-manual/native-image/guides/configure-with-tracing-agent/[Configure Native Image with the Tracing Agent]
* link:https://www.graalvm.org/jdk23/reference-manual/native-image/guides/build-spring-boot-app-into-native-executable/[Build a Native Executable from a Spring Boot Application]
* link:https://www.graalvm.org/latest/reference-manual/native-image/overview/Bundles/[Native Image Bundles]

* 替代产品： link:https://bell-sw.com/liberica-native-image-kit/[Liberica Native Image Kit]
* link:https://github.com/graalvm/container[GraalVM Container Images]
* link:https://github.com/graalvm/container/pkgs/container/native-image-community[GraalVM Container Images 列表]

* alipine: link:https://pkgs.alpinelinux.org/package/edge/testing/x86_64/openjdk21-mandrel[openjdk21-mandrel]

## FIXME

* 最常用的 Runtime AOP 机制还能使用么？
* javaAgent 机制还能用么？尤其通过 attach 机制挂载的?
* 如何运行态分析调试，比如 jfr,jstack,jamp, Alibaba Arthas, aysnc-profiler等
* System.getProperty("java.home") 没值？还有哪些系统属性没值？
* 运行态没有 jdk/jre, 那还怎么修改 `${JAVA_HOME}/conf/security/java.security`？
* 运行态如何设置 JVM 开关？java属性？
* graalvm 是否支持 跨平台构建(cross compile)? 不支持。可用docker来构建目标平台的native image.

## native-image

[source,shell]
----
which native-image
native-image --help
native-image \
  -H:DynamicProxyConfigurationResources=... \
  -H:JNIConfigurationResources=... \
  -H:ReflectionConfigurationResources=... \
  -H:ResourceConfigurationResources=${.}/custom_resources.json \
  -H:SerializationConfigurationResources=... \
  -H:BuildOutputJSONFile \
  -H:ResourceConfigurationFiles=... \
  -H:ConfigurationFileDirectories=... \
  -H:Dump=  \
  -H:MethodFilter=ClassName.MethodName
----

=== 示例：将open-test-reporting-cli fatjar 转变成对应的native image
link:https://github.com/ota4j-team/open-test-reporting?tab=readme-ov-file#cli[open-test-reporting-cli]

[source,shell]
----
DIR=/tmp/open-test-report
JAR=$HOME/.m2/repository/org/opentest4j/reporting/open-test-reporting-cli/0.2.3/open-test-reporting-cli-0.2.3-standalone.jar

mkdir -p ${DIR}/{src,agent,dest}
cat > ${DIR}/src/open-test-report.xml <<EOF
<?xml version="1.0" ?>
<e:events xmlns="https://schemas.opentest4j.org/reporting/core/0.2.0" xmlns:e="https://schemas.opentest4j.org/reporting/events/0.2.0" xmlns:git="https://schemas.opentest4j.org/reporting/git/0.2.0" xmlns:java="https://schemas.opentest4j.org/reporting/java/0.2.0" xmlns:junit="https://schemas.junit.org/open-test-reporting" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="https://schemas.junit.org/open-test-reporting https://schemas.junit.org/open-test-reporting/junit-1.9.xsd">
<infrastructure><hostName>mac.local</hostName><userName>zll</userName><operatingSystem>Mac OS X</operatingSystem><cpuCores>11</cpuCores><java:javaVersion>21.0.4</java:javaVersion><java:fileEncoding>UTF-8</java:fileEncoding><java:heapSize max="9663676416"></java:heapSize><git:repository originUrl="git@gitlab.alibaba-inc.com:mtee-bundle/gong9-ops-tools.git"></git:repository><git:branch>feature/20251224_27755112_collectDiamondConfig_1</git:branch><git:commit>4f5567c94323d5e7b9028122f891ceeb2c489e48</git:commit><git:status clean="true"><![CDATA[]]></git:status></infrastructure>
<e:started id="1" name="JUnit Jupiter" time="2025-12-31T08:08:29.872981Z"><metadata><junit:uniqueId>[engine:junit-jupiter]</junit:uniqueId><junit:legacyReportingName>JUnit Jupiter</junit:legacyReportingName><junit:type>CONTAINER</junit:type></metadata></e:started>
<e:started id="2" name="HelloTest" parentId="1" time="2025-12-31T08:08:29.878939Z"><metadata><junit:uniqueId>[engine:junit-jupiter]/[class:com.alibaba.security.gong9.ops.ut.demo.HelloTest]</junit:uniqueId><junit:legacyReportingName>com.alibaba.security.gong9.ops.ut.demo.HelloTest</junit:legacyReportingName><junit:type>CONTAINER</junit:type></metadata><sources><java:classSource className="com.alibaba.security.gong9.ops.ut.demo.HelloTest"></java:classSource></sources></e:started>
<e:started id="3" name="test01()" parentId="2" time="2025-12-31T08:08:29.888500Z"><metadata><junit:uniqueId>[engine:junit-jupiter]/[class:com.alibaba.security.gong9.ops.ut.demo.HelloTest]/[method:test01()]</junit:uniqueId><junit:legacyReportingName>test01()</junit:legacyReportingName><junit:type>TEST</junit:type></metadata><sources><java:methodSource className="com.alibaba.security.gong9.ops.ut.demo.HelloTest" methodName="test01" methodParameterTypes=""></java:methodSource></sources></e:started>
<e:finished id="3" time="2025-12-31T08:08:29.893072Z"><result status="SUCCESSFUL"></result></e:finished>
<e:started id="4" name="test02()" parentId="2" time="2025-12-31T08:08:29.894369Z"><metadata><junit:uniqueId>[engine:junit-jupiter]/[class:com.alibaba.security.gong9.ops.ut.demo.HelloTest]/[method:test02()]</junit:uniqueId><junit:legacyReportingName>test02()</junit:legacyReportingName><junit:type>TEST</junit:type></metadata><sources><java:methodSource className="com.alibaba.security.gong9.ops.ut.demo.HelloTest" methodName="test02" methodParameterTypes=""></java:methodSource></sources></e:started>
<e:finished id="4" time="2025-12-31T08:08:29.897541Z"><result status="FAILED"><java:throwable assertionError="false" type="java.lang.RuntimeException"><![CDATA[java.lang.RuntimeException: Demo Error
	at com.alibaba.security.gong9.ops.ut.demo.HelloTest.test02(HelloTest.java:30)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)
]]></java:throwable></result></e:finished>
<e:finished id="2" time="2025-12-31T08:08:29.898720Z"><result status="SUCCESSFUL"></result></e:finished>
<e:finished id="1" time="2025-12-31T08:08:29.899142Z"><result status="SUCCESSFUL"></result></e:finished>
</e:events>
EOF


# 通过 native-image-agent 找到可访达的java类型信息
java \
  -agentlib:native-image-agent=config-output-dir=${DIR}/agent \
  -jar $JAR \
  html-report \
  --output ${DIR}/dest/open-test-report.html \
  ${DIR}/src/open-test-report.xml

# 生成 reachability-metadata.json
ls -l ${DIR}/agent


# 将可执行jar包 编译成native image
native-image \
    -H:ConfigurationFileDirectories=${DIR}/agent \
    --no-fallback \
    -jar $JAR \
    ${DIR}/dest/open-test-reporting-cli

# 验证
${DIR}/dest/open-test-reporting-cli \
    html-report \
    --output ${DIR}/dest/open-test-report2.html \
    ${DIR}/src/open-test-report.xml

ls -l ${DIR}/dest/open-test-report2.html
----


## Native Image Bundles

link:https://www.graalvm.org/latest/reference-manual/native-image/overview/Bundles/[Native Image Bundles]

*.nib 文件 是一个 JAR 文件格式。

[source,shell]
----
jar tf application.nib
META-INF/MANIFEST.MF
META-INF/nibundle.properties

native-image --bundle-apply=application.nib -g
----

## GraalVM JavaScript and Node.js Runtime
link:https://www.graalvm.org/jdk22/reference-manual/js/index.html[GraalVM JavaScript and Node.js Runtime]

https://github.com/oracle/graaljs/releases/


https://javanexus.com/blog/common-pitfalls-graalvm-java


## Truffle

link:https://www.graalvm.org/latest/graalvm-as-a-platform/language-implementation-framework/[Truffle Language Implementation Framework]



== gradle plugin

link:https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html[gradle plugin]

[source,shell]
----
# 生成 native 可执行程序
./gradlew nativeCompile
# 运行生成的 native 可执行程序
./gradlew nativeRun
# 生成 native 可执行程序（来自test目录）
./gradlew nativeTestCompile
# 运行生成的 native 可执行程序（来自test目录）
./gradlew nativeTest
----
